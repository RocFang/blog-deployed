<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>nil、null与ngx.null - 纯真年代</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="nil、null与ngx.null" />
<meta property="og:description" content="问题概述

今天第一次在nginx&#43;lua架构下，写了个需要操作Redis的后台接口，该接口的功能主要是接受客户端的json格式的post请求，实现对保存在redis中的任务插入、删除、查询等。虽然nginx，lua等都是刚接触，但这几个接口还是顺风顺水的坐下来了，不能忘了感谢春哥章亦春。

在Redis中记录的任务其实很简单，每插入一个任务，就在redis中增加一个HASH结构，每次查询返回该SET的各个Field和对应的Value值，例如md5，filesize等。由于任务类型的不同，有的Field可能在该任务中不存在，此时在以json格式将查询结果返回时不应显示该Field。

以md5域为例，在对当前任务以md5域执行hget后，应该对返回结果做一个判断，如果该HASH结构并没有设置md5这个域，则跳过，继续执行后面的逻辑，如果设置了md5域，则把该域的Value取出来，插入到结果table中，后续再作为json格式返回结果的一部分，返回给后台。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pureage.info/2013/09/02/125.html" />
<meta property="article:published_time" content="2013-09-02T14:06:00&#43;00:00"/>
<meta property="article:modified_time" content="2013-09-02T14:06:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="nil、null与ngx.null"/>
<meta name="twitter:description" content="问题概述

今天第一次在nginx&#43;lua架构下，写了个需要操作Redis的后台接口，该接口的功能主要是接受客户端的json格式的post请求，实现对保存在redis中的任务插入、删除、查询等。虽然nginx，lua等都是刚接触，但这几个接口还是顺风顺水的坐下来了，不能忘了感谢春哥章亦春。

在Redis中记录的任务其实很简单，每插入一个任务，就在redis中增加一个HASH结构，每次查询返回该SET的各个Field和对应的Value值，例如md5，filesize等。由于任务类型的不同，有的Field可能在该任务中不存在，此时在以json格式将查询结果返回时不应显示该Field。

以md5域为例，在对当前任务以md5域执行hget后，应该对返回结果做一个判断，如果该HASH结构并没有设置md5这个域，则跳过，继续执行后面的逻辑，如果设置了md5域，则把该域的Value取出来，插入到结果table中，后续再作为json格式返回结果的一部分，返回给后台。"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title">纯真年代</h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">首页</a>
			</li>
			
			<li>
				<a href="/post">归档</a>
			</li>
			
			<li>
				<a href="/about">关于</a>
			</li>
			
			<li>
				<a href="/tags">标签</a>
			</li>
			
			<li>
				<a href="/tools">工具</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">nil、null与ngx.null</h1>
			<div class="meta">Posted at &mdash; Sep 2, 2013</div>
		</div>

		<div class="markdown">
			<h1 id="问题概述">问题概述</h1>

<p>今天第一次在nginx+lua架构下，写了个需要操作Redis的后台接口，该接口的功能主要是接受客户端的json格式的post请求，实现对保存在redis中的任务插入、删除、查询等。虽然nginx，lua等都是刚接触，但这几个接口还是顺风顺水的坐下来了，不能忘了感谢春哥章亦春。</p>

<p>在Redis中记录的任务其实很简单，每插入一个任务，就在redis中增加一个HASH结构，每次查询返回该SET的各个Field和对应的Value值，例如md5，filesize等。由于任务类型的不同，有的Field可能在该任务中不存在，此时在以json格式将查询结果返回时不应显示该Field。</p>

<p>以md5域为例，在对当前任务以md5域执行hget后，应该对返回结果做一个判断，如果该HASH结构并没有设置md5这个域，则跳过，继续执行后面的逻辑，如果设置了md5域，则把该域的Value取出来，插入到结果table中，后续再作为json格式返回结果的一部分，返回给后台。</p>

<p>测试时，却发现在某些域未设置时，查询结果中却仍然会把该域返回给查询调用者，但其Value部分是null。例如,执行下面的测试用例：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">curl -d &#34;{\&#34;queryfile\&#34;:[{\&#34;url\&#34;:\&#34;/www.baidu.com/img/bdlogo.gif\&#34; }]}&#34; &#34;127.0.0.1/cjson&#34;  </pre></div>
<p>尽管对该任务而言，在插入时并没有设置md5域，但返回结果包含了md5域：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">{&#34;result&#34;:[{&#34;url&#34;:&#34;\/www.baidu.com\/img\/bdlogo.gif&#34;,&#34;result&#34;:0,&#34;md5&#34;:null,&#34;putflag&#34;:&#34;remote&#34;}]}  </pre></div>
<h1 id="问题分析">问题分析</h1>

<p>看到这个现象，首先想到的当然是lua脚本中对执行hget md5操作的返回值判断失效了，我第一次是这么写的：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">local md5,err=red:hget(tasklist,&#34;md5&#34;)  
if md5 and  md5 ~= &#34;&#34;  then  
    tb.md5=md5  
end  </pre></div>
<p>从后面的结果看，当md5值为空时，该判断条件并没有将其过滤掉，依然执行了tb.md5=md5。由于redis模块也是调用春哥的lua-resty-redis，因此猜测是否春哥把redis查询结果中的空值用“null”字符串返回了，于是将上面的几行代码改为：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">local md5,err=red:hget(tasklist,&#34;md5&#34;)  
if md5 and  md5 ~= “null”  then  
    tb.md5=md5  
end  </pre></div>
<p>仍然过滤失败，忽然眼前一亮，发现查询结果中显示的是&rdquo;md5&rdquo;:null,而非&rdquo;md5&rdquo;:&ldquo;null&rdquo;，上面这种猜测不攻自破。</p>

<p>red:hget(tasklist,&ldquo;md5&rdquo;)肯定是返回了一个跟null相关的结果，但这个结果既不是nil，又不是空字符串，也不是&rdquo;null&rdquo;。再次猜测，该值类型可能不是string,虽然这个猜测看上去很奇怪，因为在设置了md5的情况下，其类型的确是string。于是在判断语句前面加了一句打印信息：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">ngx.say(&#34;type of null is &#34;..type(md5))  </pre></div>
<p>果然，这个”空值“并不是string类型，而是userdata类型，userdata类型当然跟字符串类型不会相等，所以上面的过滤条件不管设置成什么样子，都不会生效，永远会执行tb.md5=md5。</p>

<p>这样是找到原因了，但还未最终解决。既然当hget操作返回一个空值时，lua-resty-redis将其设置为一个userdata类型，那我们在代码里该如何过滤这种情况呢?本质问题就是，red:hget当查询resdis结果为空时，到底返回了什么？（不为空时，是string)</p>

<p>这时候开源的好处就体现出来了，在<a href="https://github.com/agentzh/lua-resty-redis里扫了下redis.lua文件，发现返回的是ngx.null。">https://github.com/agentzh/lua-resty-redis里扫了下redis.lua文件，发现返回的是ngx.null。</a></p>

<p>恩，问题到这就解决了，将上面的过滤代码改为：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">local md5,err=red:hget(tasklist,&#34;md5&#34;)  
if md5 and md5 ~= null and md5 ~= ngx.null  then  
    tb.md5=md5  
end  </pre></div>
<p>就能保证返回结果里不会包含值为null的域了。</p>

<h1 id="眼高手低">眼高手低</h1>

<p>回头看了一下lua-resty-redis的文档，发现关于上面的内容，在Readme里已经写的清清楚楚了，在<a href="https://github.com/agentzh/lua-resty-redis/blob/master/README.markdown中，有这么一句：">https://github.com/agentzh/lua-resty-redis/blob/master/README.markdown中，有这么一句：</a><br />
A non-nil Redis &ldquo;bulk reply&rdquo; results in a Lua string as the return value. A nil bulk reply results in a ngx.null return value.</p>

<p>首先不应该是自责，而是再次赞一下agentzh的态度，业界标杆。</p>

<h1 id="ngx-null是什么">ngx.null是什么？</h1>

<p>那么ngx.null到底是什么东西呢？ 在<a href="http://wiki.nginx.org/HttpLuaModule有如下说明：">http://wiki.nginx.org/HttpLuaModule有如下说明：</a></p>

<blockquote>
<p>The ngx.null constant is a NULL light userdata usually used to represent nil values in Lua tables etc and is similar to the lua-cjson library&rsquo;s cjson.null constant. This constant was first introduced in the v0.5.0rc5 release.</p>
</blockquote>

<p>ngx.null在print、ngx.print、ngx.log、ngx.say等函数中，有如下特点：</p>

<blockquote>
<p>Lua nil arguments are accepted and result in literal &ldquo;nil&rdquo; strings while Lua booleans result in literal &ldquo;true&rdquo; or &ldquo;false&rdquo; strings. And the ngx.null constant will yield the &ldquo;null&rdquo; string output.</p>
</blockquote>

<h1 id="为什么要这么设计">为什么要这么设计？</h1>

<p>lua-resty-redis中，为什么要把redis查询为空的情况返回一个userdata类型的ngx.null？直接返回nil不行吗？</p>

<p>答案是不行，因为nil在lua中有其特殊意义，如果一个变量被设置为nil，就等于说该变量未定义，与无穷无尽的其他未定义的变量一样。那么，如果把redis查询为空的结果设置为nil，就无法把&rdquo;查询为空”和“未定义”区分开来了，例如在一个table中，一个key对应一个value，如果将该value设置为nil，则相当让key凭空消失，这显然是不合理的。所以必须用一个userdata类型的独特的值来表示这种查询为空，但又不等同于未定义的变量，例如ngx.null。同样的情况想必在sql的lua模块中也会出现，用来处理记录中键值查询为空的情况。</p>

<h1 id="幽灵般的nil">幽灵般的nil</h1>

<p>这就要说道lua中神奇的nil了。nil是一种类型，该类型只有一个值，这个值也叫nil。改值的作用只有一个，表示一个变量不存在。跟C\C++等常规语言不同，”不存在“跟空、0完全是两个概念。在C语言中，一个字符串如果为空，那么它就只有一个为0的\nul结束符，如果对齐进行逻辑判断，则是假。<br />
但lua中，只要一个变量不是nil类型或者是boolean类型中的false,则对它进行逻辑判断，结果是真，即使该值是一个数字0，或者是一个空字符串。</p>
		</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = '';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div><a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


</body>
</html>
