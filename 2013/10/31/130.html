<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="strider (方鹏)">
<meta name="description" content="一个伪文青兼程序员的自嗨
    ">
<meta name="keywords" content="博客, 技术, 文学, 电影">
<meta name="referrer" content="always">
<title>关于proxy_pass的参数路径问题 - 纯真年代</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://pureage.info/">纯真年代</a></h1><h2><a href="https://pureage.info/">阅读、体验、沉淀...</a></h2>
  </div>
  <nav><a href="/">博客</a><a href="/tools/">工具</a><a href="/about/">关于</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>关于proxy_pass的参数路径问题</h1>
  </div>
<div class="meta">
  <div>2013-10-31</div>
  <div>
    <span><a href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98">#程序员</a></span>
    <span><a href="/tags/nginx">#nginx</a></span>
    </div>
  </div>
<div class="content">
  <p>由于工作需要，开始分析nginx的proxy模块，在分析之前，当然要先会用了。于是开始熟悉该模块的一些指令，其中最基本的指令要属proxy_pass了。nginx的英文文档总是看着感觉有些别扭，于是按惯例先google了一些文章。</p>
<p>这一搜，就掉进坑里了。</p>
<p>这些文章里都把proxy_pass的目标地址是形如“127.0.0.1:8090”和“127.0.0.1:8090/”分开讨论，认为后者“/&ldquo;的作用是删除url中匹配的部分，然后再讨论目标地址中带了uri的情况。</p>
<p>其实根本没这么复杂，只有两种情况：</p>
<p>（1）目标地址中不带uri。即proxy_pass的参数形如&quot;http://127.0.0.1:8090&rdquo;。
此时新的目标url中，匹配的uri部分不做修改，原来是什么样就是什么样。</p>
<p>（2）目标地址中带uri。即proxy_pass的参数形如“http://127.0.0.1:8090/dir1/dir2&rdquo;</p>
<p>此时新的目标url中，匹配的uri部分将会被修改为该参数中的uri，如&quot;http://127.0.0.1:8888/dir1/dir2.&rdquo;</p>
<p>有人说，你没有讨论ip和端口后带不带”/“的区别。其实是不需要的，因为&rdquo;/&ldquo;本身就是一种uri，很明显属于上面的第二种情况，只不过是把原来的uri修改为了现在的uri（”/&quot;)，看上去，像是删除了原url中匹配的部分。如果不理解这一点，就会总想着去牢记、区分结尾带不带&rdquo;/&ldquo;的情况。<br>
官方文档也是这么叙述的，根本没有提及半句“/&quot;：</p>
<blockquote>
<p>A request URI is passed to the server as follows:</p>
<p>If the proxy_pass directive is specified with a URI, then when a request is passed to the server, the part of a normalized request URI matching the location is replaced by a URI specified in the directive:<br>
location /name/ {<br>
proxy_pass http://127.0.0.1/remote/;<br>
}<br>
If proxy_pass is specified without a URI, the request URI is passed to the server in the same form as sent by a client when the original request is processed, or the full normalized request URI is passed when processing the changed URI:<br>
location /some/path/ {<br>
proxy_pass http://127.0.0.1;<br>
}</p>
</blockquote>
<p>测试部分如下。</p>
<p>如果配置为：</p>
<blockquote>
<p>server {<br>
listen 9090;<br>
access_log /home/strider/project/nginx/nginx-1.4.2/log/access_9090.log;<br>
location /test1/test2/{<br>
proxy_pass http://127.0.0.1:8090;<br>
}<br>
}</p>
</blockquote>
<p>则有如下对应关系：</p>
<pre><code>127.0.0.1:9090/test1/test2/echo1-----&gt;127.0.0.1:8090/test1/test2/echo1  
127.0.0.1:9090/test1/test2/----&gt;127.0.0.1:8090/test1/test2  
</code></pre><p>如果配置为：</p>
<blockquote>
<p>server {<br>
listen 9090;<br>
access_log /home/strider/project/nginx/nginx-1.4.2/log/access_9090.log;<br>
location /test1/test2/{<br>
proxy_pass http://127.0.0.1:8090/;<br>
}<br>
}</p>
</blockquote>
<p>则有如下对应关系：</p>
<pre><code>127.0.0.1:9090/test1/test2/echo1-----&gt;127.0.0.1:8090/echo1  
127.0.0.1:9090/test1/test2/----&gt;127.0.0.1:8090/  
</code></pre><p>如果配置为：</p>
<blockquote>
<p>server {<br>
listen 9090;<br>
access_log /home/strider/project/nginx/nginx-1.4.2/log/access_9090.log;<br>
location /test1/test2/{<br>
proxy_pass http://127.0.0.1:8090/test1;<br>
}<br>
}</p>
</blockquote>
<p>则有如下对应关系：</p>
<pre><code>127.0.0.1:9090/test1/test2/echo1-----&gt;127.0.0.1:8090/test1echo1  
127.0.0.1:9090/test1/test2/----&gt;127.0.0.1:8090/test1  
</code></pre><p>如果配置为：</p>
<blockquote>
<p>server {<br>
listen 9090;<br>
access_log /home/strider/project/nginx/nginx-1.4.2/log/access_9090.log;<br>
location /test1/test2/{<br>
proxy_pass http://127.0.0.1:8090/test3/test4/test5;<br>
}<br>
}</p>
</blockquote>
<p>则有如下对应关系：</p>
<pre><code>127.0.0.1:9090/test1/test2/echo1-----&gt;127.0.0.1:8090/test3/test4/test5echo1  
127.0.0.1:9090/test1/test2/----&gt;127.0.0.1:80990/test3/test4/test5  
</code></pre></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2011-2020 strider. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
