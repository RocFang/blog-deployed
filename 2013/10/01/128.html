<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="strider (方鹏)">
<meta name="description" content="一个伪文青兼程序员的自嗨
    ">
<meta name="keywords" content="博客, 技术, 文学, 电影">
<meta name="referrer" content="always">
<title>emlog 的一键备份 - 纯真年代</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://pureage.info/">纯真年代</a></h1><h2><a href="https://pureage.info/">阅读、体验、沉淀...</a></h2>
  </div>
  <nav><a href="/">博客</a><a href="/tools/">工具</a><a href="/about/">关于</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>emlog 的一键备份</h1>
  </div>
<div class="meta">
  <div>2013-10-01</div>
  <div>
    <span><a href="/tags/%E5%8D%9A%E5%AE%A2">#博客</a></span>
    <span><a href="/tags/shell">#shell</a></span>
    </div>
  </div>
<div class="content">
  <p>对于一个托管在 LAMP 虚拟主机（不是 vps）环境下的 emlog 博客，不知道大家平时备份是不是和我一样这么操作的：</p>
<ol>
<li>登陆到后台，备份数据库（当然，或者是用插件定期备份发送到邮箱）</li>
<li>用 ftp 备份 content 目录</li>
</ol>
<p>如果你想简化操作，下面的脚本也许可以帮到你。脚本很丑陋，能完成功能即可。</p>
<h2 id="1-linux">1. linux</h2>
<p>（1）将下面脚本中 config 标记部分需要自己配置，意义如下：</p>
<ul>
<li>backup_path：content 目录和 sql 文件要存放的目录</li>
<li>emlog_domain：你的博客域名，例如：<code>http://www.pureage.info</code></li>
<li>emlog_user：你博客的登录名</li>
<li>emlog_password：你博客的登陆密码</li>
<li>remotecontent：你 ftp 上 content 目录的完整 url，带上你的 ftp 账号和密码信息，例如：      <code>ftp://admin:password@127.0.0.1/domains/xxxx.com/public_html/content</code> 将admin、password改成你自己的 ftp 账号、密码，把 127.0.0.1 改成你 ftp 的 IP（通常就是主机 IP），<code>domains/xxxx.com/public_html/contentg</code> 改成你自己的 content 在 ftp 上的目录即可。</li>
</ul>
<p>（2）假设将该脚本命名为 emlog_backup.sh，执行 chmod +x emlog_backup.sh，赋予可执行属性。</p>
<p>（3）执行./emlog_backup.sh：</p>
<ul>
<li>如果不带参数，或执行 <code>./emlog_backup.sh all</code> 则先备份数据库，再备份 content 目录</li>
<li>如果是执行 <code>./emlog_backup.sh sql</code>，则只备份数据库</li>
<li>如果是执行 <code>./emlog_backup.sh content</code>，则只备份 content 目录</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#888;font-style:italic">#!/bin/bash  
</span><span style="color:#888;font-style:italic"></span>  
<span style="color:#888;font-style:italic">#-----config------------</span>  
<span style="color:#000">backup_path</span>=<span style="color:#5a2">&#34;/home/strider/blog/backup&#34;</span>  
<span style="color:#000">emlog_domain</span>=<span style="color:#5a2">&#34;http://www.pureage.info&#34;</span>  
<span style="color:#000">emlog_user</span>=<span style="color:#5a2">&#34;aaaaa&#34;</span>  
<span style="color:#000">emlog_password</span>=<span style="color:#3af">123456</span>  
<span style="color:#000">remote_content</span>=<span style="color:#5a2">&#34;ftp://admin:123456@127.0.0.1/domains/pureage.info/public_html/content&#34;</span>  
<span style="color:#888;font-style:italic">#----------------------</span>  
  
  
<span style="color:#888;font-style:italic">#-----</span>  
mkdir -p <span style="color:#5a2">&#34;</span><span style="color:#000">$backup_path</span><span style="color:#5a2">&#34;</span>  
  
<span style="color:#00f">if</span> [ -d <span style="color:#5a2">&#34;</span><span style="color:#000">$backup_path</span><span style="color:#5a2">/content</span><span style="color:#5a2">&#34;</span> ];<span style="color:#00f">then</span>  
mv <span style="color:#5a2">&#34;</span><span style="color:#000">$backup_path</span><span style="color:#5a2">/content</span><span style="color:#5a2">&#34;</span> <span style="color:#5a2">&#34;</span><span style="color:#000">$backup_path</span><span style="color:#5a2">/content_old</span><span style="color:#5a2">&#34;</span>  
<span style="color:#00f">fi</span>  
  
  
  
backup_database()  
{  
        <span style="color:#888;font-style:italic">#----get the cookie----</span>  
        curl -d <span style="color:#5a2">&#34;</span><span style="color:#5a2">user=</span><span style="color:#000">$emlog_user</span><span style="color:#5a2">&amp;pw=</span><span style="color:#000">$emlog_password</span><span style="color:#5a2">&#34;</span>  <span style="color:#5a2">&#34;</span><span style="color:#000">$emlog_domain</span><span style="color:#5a2">&#34;</span>/admin/index.php?action=login -c <span style="color:#5a2">&#34;</span><span style="color:#000">$backup_path</span><span style="color:#5a2">/cookie</span><span style="color:#5a2">&#34;</span>  
  
  
        <span style="color:#888;font-style:italic">#----back up database----</span>  
        <span style="color:#000">table_backup</span>=(  
        <span style="color:#5a2">&#34;emlog_attachment&#34;</span>  
        <span style="color:#5a2">&#34;emlog_blog&#34;</span>  
        <span style="color:#5a2">&#34;emlog_comment&#34;</span>  
        <span style="color:#5a2">&#34;emlog_options&#34;</span>  
        <span style="color:#5a2">&#34;emlog_navi&#34;</span>  
        <span style="color:#5a2">&#34;emlog_reply&#34;</span>  
        <span style="color:#5a2">&#34;emlog_sort&#34;</span>  
        <span style="color:#5a2">&#34;emlog_link&#34;</span>  
        <span style="color:#5a2">&#34;emlog_tag&#34;</span>  
        <span style="color:#5a2">&#34;emlog_trackback&#34;</span>  
        <span style="color:#5a2">&#34;emlog_twitter&#34;</span>  
        <span style="color:#5a2">&#34;emlog_user&#34;</span>  
        )  
        <span style="color:#000">table_box</span>=<span style="color:#00f">$(</span>  
        <span style="color:#000">let</span> <span style="color:#000">i</span>=0;  
        <span style="color:#00f">for</span>((<span style="color:#000">i</span>=0;i&lt;<span style="color:#5a2">${#</span><span style="color:#000">table_backup</span>[@]<span style="color:#5a2">}</span>-1;<span style="color:#000">i</span>=i+1<span style="color:#00f">)</span>)  
        <span style="color:#00f">do</span>  
        <span style="color:#000">echo</span> -n <span style="color:#5a2">&#34;</span><span style="color:#5a2">table_box[</span><span style="color:#000">$i</span><span style="color:#5a2">]=</span><span style="color:#5a2">${</span><span style="color:#000">table_backup</span>[<span style="color:#000">$i</span>]<span style="color:#5a2">}</span><span style="color:#5a2">&amp;</span><span style="color:#5a2">&#34;</span>  
        <span style="color:#00f">done</span>  
        <span style="color:#000">echo</span> -n <span style="color:#5a2">&#34;</span><span style="color:#5a2">table_box[</span><span style="color:#000">$i</span><span style="color:#5a2">]=</span><span style="color:#5a2">${</span><span style="color:#000">table_backup</span>[<span style="color:#000">$i</span>]<span style="color:#5a2">}</span><span style="color:#5a2">&#34;</span>  
        )  
        <span style="color:#000">echo</span> <span style="color:#000">$table_box</span>  
  
        <span style="color:#000">sql_file</span>=<span style="color:#5a2">&#34;</span><span style="color:#00f">$(</span>date <span style="color:#5a2">&#34;+%Y_%m_%d_%H_%M_%S&#34;</span><span style="color:#00f">)</span><span style="color:#5a2">.sql</span><span style="color:#5a2">&#34;</span>  
  
        curl  -b <span style="color:#5a2">&#34;</span><span style="color:#000">$backup_path</span><span style="color:#5a2">/cookie</span><span style="color:#5a2">&#34;</span> -L    -d <span style="color:#5a2">&#34;</span><span style="color:#000">$table_box</span><span style="color:#5a2">&#34;</span>  <span style="color:#5a2">&#34;</span><span style="color:#000">$emlog_domain</span><span style="color:#5a2">&#34;</span>/admin/data.php?action=bakstart&gt;<span style="color:#5a2">&#34;</span><span style="color:#000">$backup_path</span><span style="color:#5a2">/</span><span style="color:#000">$sql_file</span><span style="color:#5a2">&#34;</span>  
  
        <span style="color:#888;font-style:italic">#----delete the cookie----</span>  
        rm -rf <span style="color:#5a2">&#34;</span><span style="color:#000">$backup_path</span><span style="color:#5a2">/cookie</span><span style="color:#5a2">&#34;</span>  
}  
  
backup_content()  
{  
        wget  -r  -nH --cut-dirs=<span style="color:#3af">3</span>  -nv <span style="color:#5a2">&#34;</span><span style="color:#000">$remote_content</span><span style="color:#5a2">&#34;</span> -P <span style="color:#5a2">&#34;</span><span style="color:#000">$backup_path</span><span style="color:#5a2">&#34;</span>  
  
        <span style="color:#888;font-style:italic">#----delete old content</span>  
        <span style="color:#00f">if</span>  [ -d <span style="color:#5a2">&#34;</span><span style="color:#000">$backup__path</span><span style="color:#5a2">/content</span><span style="color:#5a2">&#34;</span> ];<span style="color:#00f">then</span>  
                rm -rf <span style="color:#5a2">&#34;</span><span style="color:#000">$backup_path</span><span style="color:#5a2">/content</span><span style="color:#5a2">&#34;</span>  
        <span style="color:#00f">fi</span>  
}  
  
  
<span style="color:#00f">if</span> [ <span style="color:#000">$#</span> -eq <span style="color:#3af">0</span> ];<span style="color:#00f">then</span>  
        backup_database  
        backup_content  
        <span style="color:#000">exit</span> <span style="color:#3af">0</span>  
  
<span style="color:#00f">elif</span> [ <span style="color:#000">$#</span> -eq <span style="color:#3af">1</span> ];<span style="color:#00f">then</span>  
        <span style="color:#00f">if</span> [ <span style="color:#5a2">&#34;</span><span style="color:#000">$1</span><span style="color:#5a2">&#34;</span> == <span style="color:#5a2">&#34;all&#34;</span> ];<span style="color:#00f">then</span>  
                backup_database  
                backup_content  
                <span style="color:#000">exit</span> <span style="color:#3af">0</span>  
  
        <span style="color:#00f">elif</span> [ <span style="color:#5a2">&#34;</span><span style="color:#000">$1</span><span style="color:#5a2">&#34;</span> == <span style="color:#5a2">&#34;sql&#34;</span> ];<span style="color:#00f">then</span>  
                backup_database  
                <span style="color:#000">exit</span> <span style="color:#3af">0</span>  
  
        <span style="color:#00f">elif</span> [ <span style="color:#5a2">&#34;</span><span style="color:#000">$1</span><span style="color:#5a2">&#34;</span> == <span style="color:#5a2">&#34;content&#34;</span> ];<span style="color:#00f">then</span>  
                backup_content  
                <span style="color:#000">exit</span> <span style="color:#3af">0</span>  
        <span style="color:#00f">else</span>  
                <span style="color:#000">echo</span> <span style="color:#5a2">&#34;operation not supported!&#34;</span>  
                <span style="color:#000">exit</span> <span style="color:#3af">1</span>  
        <span style="color:#00f">fi</span>  
  
<span style="color:#00f">else</span>  
        <span style="color:#000">echo</span> <span style="color:#5a2">&#34;operation not supported!&#34;</span>  
        <span style="color:#000">exit</span> <span style="color:#3af">1</span>  
<span style="color:#00f">fi</span>  
</code></pre></div><h2 id="2-windows">2. windows</h2>
<p>由于对 bat 不熟，所以没有写成上面那种比较详细的脚本。但其实上面真正有用的只有三句：两个 curl 语句和一个 wget 语句。而 curl 和 wget 都有 windows 版本的。也很好写，最简单的例子，把下面的内容复制到一个文本里，将其改名为 emlog_backup.bat，也可以工作：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmd" data-lang="cmd">curl -d <span style="color:#5a2">&#34;</span><span style="color:#5a2">user=xxxx&amp;pw=123456</span><span style="color:#5a2">&#34;</span>  http://www.pureage.info/admin/index.php?action=login -c cookie  
  
curl  -b cookie -L -d <span style="color:#5a2">&#34;</span><span style="color:#5a2">table_box[0]=emlog_attachment&amp;table_box[1]=emlog_blog&amp;table_box[2]=emlog_comment&amp;table_box[3]=emlog_options&amp;table_box[4]=emlog_navi&amp;table_box[5]=emlog_reply&amp;table_box[6]=emlog_sort&amp;table_box[7]=emlog_link&amp;table_box[8]=emlog_tag&amp;table_box[9]=emlog_trackback&amp;table_box[10]=emlog_twitter&amp;table_box[11]=emlog_user</span><span style="color:#5a2">&#34;</span>  www.pureage.info/admin/data.php?action=bakstart<span style="color:#3af"></span>&gt;myemlog.sql  
  
wget  -r  -nH --cut-dirs=3 -nv  ftp://admin:123456@127.0.0.1/domains/pureage.info/public_html/content  
</code></pre></div></div>

  </article>
</main>
<footer>
  <div>
    <div>2011-2020 strider. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a><p>Powered by <a href="https://gohugo.io/">Hugo</a> with <a href="https://github.com/yanlinlin82/simple-style">Simple-Style</a></div>
  </div>
</footer>
</body>
</html>
