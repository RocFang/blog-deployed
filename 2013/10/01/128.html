<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="strider (方鹏)">
<meta name="description" content="一个伪文青兼程序员的自嗨
    ">
<meta name="keywords" content="博客, 技术, 文学, 电影">
<meta name="referrer" content="always">
<title>emlog的一键备份 - 纯真年代</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://pureage.info/">纯真年代</a></h1><h2><a href="https://pureage.info/">阅读、体验、沉淀...</a></h2>
  </div>
  <nav><a href="/">博客</a><a href="/tools/">工具</a><a href="/about/">关于</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>emlog的一键备份</h1>
  </div>
<div class="meta">
  <div>2013-10-01</div>
  <div>
    <span><a href="/tags/%E5%8D%9A%E5%AE%A2">#博客</a></span>
    <span><a href="/tags/shell">#shell</a></span>
    </div>
  </div>
<div class="content">
  <p>不知道大家平时备份是不是和我一样这么操作的：</p>
<ol>
<li>登陆到后台，备份sql（当然，或者是用插件定期备份发送到邮箱）</li>
<li>用ftp备份content目录</li>
</ol>
<p>如果你想简化操作，并且和我一样苦逼的用着虚拟主机，下面的脚本也许可以帮到你。脚本很丑陋，能完成功能即可。</p>
<p><strong>1.linux</strong></p>
<p>（1） 将下面脚本中config标记部分需要自己配置，意义如下：</p>
<ul>
<li>backup_path：content目录和sql文件要存放的目录</li>
<li>emlog_domain:你的博客域名，例如：http://www.pureage.info</li>
<li>emlog_user:你博客的登录名</li>
<li>emlog_password：你博客的登陆密码</li>
<li>remotecontent：你ftp上content目录的完整url，带上你的ftp账号和密码信息，例如：     ftp://admin:password@127.0.0.1/domains/xxxx.com/public_html/content 将admin,password改成你自己的ftp账号、密码，把127.0.0.1改成你ftp的IP（通常就是主机IP）,domains/xxxx.com/public_html/contentg改成你自己的content在ftp上的目录即可。</li>
</ul>
<p>（2）假设将该脚本命名为emlog_backup.sh，执行chmod +x emlog_backup.sh，赋予可执行属性。</p>
<p>（3）执行./emlog_backup.sh:</p>
<ul>
<li>如果不带参数，或执行./emlog_backup.sh all 则先备份数据库，再备份content目录</li>
<li>如果是执行./emlog_backup.sh sql，则只备份数据库</li>
<li>如果是执行./emlog_backup.sh content，则只备份content目录</li>
</ul>
<pre><code>#!/bin/bash  
  
#-----config------------  
backup_path=&quot;/home/strider/blog/backup&quot;  
emlog_domain=&quot;http://www.pureage.info&quot;  
emlog_user=&quot;aaaaa&quot;  
emlog_password=123456  
remote_content=&quot;ftp://admin:123456@127.0.0.1/domains/pureage.info/public_html/content&quot;  
#----------------------  
  
  
#-----  
mkdir -p &quot;$backup_path&quot;  
  
if [ -d &quot;$backup_path/content&quot; ];then  
mv &quot;$backup_path/content&quot; &quot;$backup_path/content_old&quot;  
fi  
  
  
  
backup_database()  
{  
        #----get the cookie----  
        curl -d &quot;user=$emlog_user&amp;pw=$emlog_password&quot;  &quot;$emlog_domain&quot;/admin/index.php?action=login -c &quot;$backup_path/cookie&quot;  
  
  
        #----back up database----  
        table_backup=(  
        &quot;emlog_attachment&quot;  
        &quot;emlog_blog&quot;  
        &quot;emlog_comment&quot;  
        &quot;emlog_options&quot;  
        &quot;emlog_navi&quot;  
        &quot;emlog_reply&quot;  
        &quot;emlog_sort&quot;  
        &quot;emlog_link&quot;  
        &quot;emlog_tag&quot;  
        &quot;emlog_trackback&quot;  
        &quot;emlog_twitter&quot;  
        &quot;emlog_user&quot;  
        )  
        table_box=$(  
        let i=0;  
        for((i=0;i&lt;${#table_backup[@]}-1;i=i+1))  
        do  
        echo -n &quot;table_box[$i]=${table_backup[$i]}&amp;&quot;  
        done  
        echo -n &quot;table_box[$i]=${table_backup[$i]}&quot;  
        )  
        echo $table_box  
  
        sql_file=&quot;$(date &quot;+%Y_%m_%d_%H_%M_%S&quot;).sql&quot;  
  
        curl  -b &quot;$backup_path/cookie&quot; -L    -d &quot;$table_box&quot;  &quot;$emlog_domain&quot;/admin/data.php?action=bakstart&gt;&quot;$backup_path/$sql_file&quot;  
  
        #----delete the cookie----  
        rm -rf &quot;$backup_path/cookie&quot;  
}  
  
backup_content()  
{  
        wget  -r  -nH --cut-dirs=3  -nv &quot;$remote_content&quot; -P &quot;$backup_path&quot;  
  
        #----delete old content  
        if  [ -d &quot;$backup__path/content&quot; ];then  
                rm -rf &quot;$backup_path/content&quot;  
        fi  
}  
  
  
if [ $# -eq 0 ];then  
        backup_database  
        backup_content  
        exit 0  
  
elif [ $# -eq 1 ];then  
        if [ &quot;$1&quot; == &quot;all&quot; ];then  
                backup_database  
                backup_content  
                exit 0  
  
        elif [ &quot;$1&quot; == &quot;sql&quot; ];then  
                backup_database  
                exit 0  
  
        elif [ &quot;$1&quot; == &quot;content&quot; ];then  
                backup_content  
                exit 0  
        else  
                echo &quot;operation not supported!&quot;  
                exit 1  
        fi  
  
else  
        echo &quot;operation not supported!&quot;  
        exit 1  
fi  
</code></pre><p><strong>2.windows</strong></p>
<p>由于对bat不熟，所以没有写成上面那种比较详细的脚本。但其实上面真正有用的只有三句：两个curl语句和一个wget语句。而curl和wget都有windows版本的。也很好写，最简单的例子，把下面的内容复制到一个文本里，将其改名为emlog_backup.bat，也可以工作：</p>
<pre><code>curl -d &quot;user=xxxx&amp;pw=123456&quot;  http://www.pureage.info/admin/index.php?action=login -c cookie  
  
curl  -b cookie -L -d &quot;table_box[0]=emlog_attachment&amp;table_box[1]=emlog_blog&amp;table_box[2]=emlog_comment&amp;table_box[3]=emlog_options&amp;table_box[4]=emlog_navi&amp;table_box[5]=emlog_reply&amp;table_box[6]=emlog_sort&amp;table_box[7]=emlog_link&amp;table_box[8]=emlog_tag&amp;table_box[9]=emlog_trackback&amp;table_box[10]=emlog_twitter&amp;table_box[11]=emlog_user&quot;  www.pureage.info/admin/data.php?action=bakstart&gt;myemlog.sql  
  
wget  -r  -nH --cut-dirs=3 -nv  ftp://admin:123456@127.0.0.1/domains/pureage.info/public_html/content  
</code></pre></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2011-2020 strider. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
