<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="strider (方鹏)">
<meta name="description" content="一个伪文青兼程序员的自嗨
    ">
<meta name="keywords" content="博客, 技术, 文学, 电影">
<meta name="referrer" content="always">
<title>bash 下如何实现 perl 中 seek 的功能？ - 纯真年代</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://pureage.info/">纯真年代</a></h1><h2><a href="https://pureage.info/">阅读、体验、沉淀...</a></h2>
  </div>
  <nav><a href="/">博客</a><a href="/tools/">工具</a><a href="/about/">关于</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>bash 下如何实现 perl 中 seek 的功能？</h1>
  </div>
<div class="meta">
  <div>2013-07-21</div>
  <div>
    <span><a href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98">#程序员</a></span>
    <span><a href="/tags/shell">#shell</a></span>
    </div>
  </div>
<div class="content">
  <p>因为日志处理需要，接触到 perl，虽然还未入门，但通过几个函数就可以发现其在文本处理上的威力确实名不虚传，更不用提正则表达式了。</p>
<p>假设有这样的应用场景：客户通过 ftp 客户端上传文件到接入端 ftp 服务器，接入端 ftp 服务器作为分布式存储系统的客户端，再将这些文件存入到后面的分布式存储服务器中。这个接入端 ftp 服务器要做的工作就是定时分析 ftp server（假设是 vsftpd，日志为 xferlog）的日志来获取客户上传的文件，再对这些文件做后续处理。客户上传时随时进行的，xferlog 的记录条数也随之增长。</p>
<p>perl 中通过 seek 函数可以很方便的做到，每一次脚本执行时，都将上一次脚本执行时 xferlog 的大小作为本次读操作的偏移量，用这个偏移量来调用 seek，本次处理完后再将该偏移量更新后存入到一个文件供下次脚本执行时读取。</p>
<p>如果是 bash 该如何实现呢？shell 内置的文件操作的命令很少，只好借助外部程序。我只想到了通过 dd 来实现：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">touch file_size  
  
<span style="color:#888;font-style:italic">#读偏移量</span>  
<span style="color:#000">a</span>=<span style="color:#5a2">`</span>cat readfile<span style="color:#5a2">`</span>  
<span style="color:#000">echo</span> <span style="color:#000">$a</span>  
  
<span style="color:#888;font-style:italic">#把偏移量作为dd的参数</span>  
<span style="color:#000">skip</span>=<span style="color:#000">$a</span>  
  
<span style="color:#888;font-style:italic">#从上一次读取的地方开始复制到file2，（跳过上一次的字节，就是这次的开始）</span>  
dd <span style="color:#00f">if</span>=file1 <span style="color:#000">of</span>=file2 <span style="color:#000">bs</span>=<span style="color:#3af">1</span> <span style="color:#000">skip</span>=<span style="color:#000">$skip</span>  
<span style="color:#888;font-style:italic">#获得新增内容的大小（字节）</span>  
<span style="color:#000">size1</span>=<span style="color:#5a2">`</span>wc -c file2 | awk <span style="color:#5a2">&#39;{print $1}&#39;</span><span style="color:#5a2">`</span>  
<span style="color:#888;font-style:italic">#获取下次需要skip 的字节数</span>  
<span style="color:#000">sum</span>=<span style="color:#5a2">`</span>expr <span style="color:#000">$a</span> + <span style="color:#000">$size1</span><span style="color:#5a2">`</span>  
<span style="color:#888;font-style:italic">#记录偏移量</span>  
<span style="color:#000">echo</span> <span style="color:#000">$sum</span>&gt;file_size  
<span style="color:#888;font-style:italic">#进行本次处理</span>  
<span style="color:#00f">while</span> <span style="color:#000">read</span> line  
<span style="color:#00f">do</span>  
    <span style="color:#888;font-style:italic">#do something</span>  
<span style="color:#00f">done</span>&lt;file2  
</code></pre></div><p>perl 一个函数 seek 就可以搞定的事情，用这种方法却需要这么拐弯抹角。不光调用了 dd，而且还新增了一个临时文件。当然，这些只是从应用上看，效率上的差异暂时不是我要考虑的问题。</p></div>

  </article>
</main>
<footer>
  <div>
    <div>2011-2020 strider. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
