<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="strider (方鹏)">
<meta name="description" content="一个伪文青兼程序员的自嗨
    ">
<meta name="keywords" content="博客, 技术, 文学, 电影">
<meta name="referrer" content="always">
<title>lua-nginx 使用自定义变量时需要说明的一点 - 纯真年代</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://pureage.info/">纯真年代</a></h1><h2><a href="https://pureage.info/">阅读、体验、沉淀...</a></h2>
  </div>
  <nav><a href="/">博客</a><a href="/tools/">工具</a><a href="/about/">关于</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>lua-nginx 使用自定义变量时需要说明的一点</h1>
  </div>
<div class="meta">
  <div>2014-01-20</div>
  <div>
    <span><a href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98">#程序员</a></span>
    <span><a href="/tags/nginx">#nginx</a></span>
    </div>
  </div>
<div class="content">
  <p>在 Nginx 中，有两种方式添加自定义的变量：</p>
<ul>
<li>在配置文件中用 set 指定添加</li>
<li>在自己编写的 C 模块中，调用 <code>ngx_http_add_variable</code> 接口来添加变量</li>
</ul>
<p>第一种方法较简单，第二种方法有一处需要说明一下。</p>
<p>当调用 <code>ngx_http_add_variable</code> 接口时，如果传入的 flag 参数中  <code>NGX_HTTP_VAR_NOHASH</code> 位被设置了，那么在 lua 代码中使用 ngx.var.XXX 是不能访问到该变量的，得到的值是 <code>nil</code>。</p>
<p>在这种情况下，如果现在配置文件中通过set指定一个中间变量，则在lua代码中可以访问到。</p>
<p>例如，某个 C 模块中用带有 <code>NGX_HTTP_VAR_NOHASH</code> 位的 flag 参数调用了  <code>ngx_http_add_variable</code>，创建了变量 A，则如果在 lua 代码中通过 <code>ngx.var.A</code> 只能得到一个 <code>nil</code> 值。</p>
<p>而如果在配置文件中，先调用 set 命令：<code>set $B $A；</code>，那么在 lua 代码中，通过代码 <code>local A2 = ngx.var.B</code> 则可以间接访问到该变量。</p>
<p>翻了一下邮件列表，发现该问题 agentzh 早有解答：</p>
<blockquote>
<p>逆雪寒：</br>
通过 <code>ngx.var.fastcgi_script_name</code> 是 <code>nil</code> 。 但 <code>set $fsn $fastcgi_script_name</code> 然后 <code>ngx.var.fsn</code> 就能正常获取了。bug  ? 还是我理解问题？</p>
</blockquote>
<blockquote>
<p>agenzh：</br></p>
<p>这是 Nginx 标准的 <code>ngx_fastcgi</code> 模块的一个限制。<code>$fastcgi_script_name</code> 这个内建变量是这个 <code>ngx_fastcgi</code> 模块定义的，而且在定义时设置了 <code>NGX_HTTP_VAR_NOHASH</code> 这个标志位，从而阻止了 Perl、Lua 等各种脚本语言在请求时按变量名动态获取这个变量的值。</p>
<p>之所以你使用 set 指令进行过渡就可以工作是因为 set 指令定位 <code>$fastcgi_script_name</code> 这个变量是在配置加载时，而不是请求时。</p>
<p>你可以自己修改 Nginx 源码树中的 <code>src/http/modules/ngx_http_fastcgi_module.c</code> 这个文件，从<code>ngx_http_fastcgi_vars</code> 这个全局数组的初始化定义中把 <code>NGX_HTTP_VAR_NOHASH</code> 这个标志去除。</p>
<p>从 ngx_lua 模块的角度，是没办法绕过 Nginx 核心中的这个限制的。关于类似这样的问题，可以参见下面这个讨论：</p>
<p><a href="http://forum.nginx.org/read.php?29,239402,239402,quote=1">http://forum.nginx.org/read.php?29,239402,239402,quote=1</a></p>
</blockquote></div>

  </article>
</main>
<footer>
  <div>
    <div>2011-2020 strider. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a><p>Powered by <a href="https://gohugo.io/">Hugo</a> with <a href="https://github.com/yanlinlin82/simple-style">Simple-Style</a></div>
  </div>
</footer>
</body>
</html>
