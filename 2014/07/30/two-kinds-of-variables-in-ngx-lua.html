<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="strider (方鹏)">
<meta name="description" content="一个伪文青兼程序员的自嗨
    ">
<meta name="keywords" content="博客, 技术, 文学, 电影">
<meta name="referrer" content="always">
<title>ngx.var.arg 与 ngx.req.get_uri_args 的区别 - 纯真年代</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://pureage.info/">纯真年代</a></h1><h2><a href="https://pureage.info/">阅读、体验、沉淀...</a></h2>
  </div>
  <nav><a href="/">博客</a><a href="/tools/">工具</a><a href="/about/">关于</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>ngx.var.arg 与 ngx.req.get_uri_args 的区别</h1>
  </div>
<div class="meta">
  <div>2014-07-30</div>
  <div>
    <span><a href="/tags/nginx">#nginx</a></span>
    </div>
  </div>
<div class="content">
  <p><code>ngx.var.arg_xx</code> 与 <code>ngx.req.get_uri_args[&quot;xx&quot;]</code> 两者都是为了获取请求 uri 中的参数，例如对于 url：</p>
<pre><code>http://pureage.info?strider=1  
</code></pre><p>为了获取输入参数 strider，以下两种方法都可以：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#00f">local</span> <span style="color:#000">strider</span> = <span style="color:#000">ngx.var</span>.<span style="color:#000">arg_strider</span>
</code></pre></div><div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#00f">local</span> <span style="color:#000">strider</span> = <span style="color:#000">ngx.req</span>.<span style="color:#000">get_uri_args</span>[<span style="color:#5a2">&#34;</span><span style="color:#5a2">strider</span><span style="color:#5a2">&#34;</span>]
</code></pre></div><p>差别在于，当请求 uri 中有多个同名参数时，<code>ngx.var.arg_xx</code> 的做法是取第一个出现的值，<code>ngx.req_get_uri_args[&quot;xx&quot;]</code> 的做法是返回一个 table，该 table 里存放了该参数的所有值，例如,当请求 uri 为：</p>
<pre><code>http://pureage.info?strider=1&amp;strider=2&amp;strider=3&amp;strider=4  
</code></pre><p>此时，<code>ngx.var.arg_strider</code> 的值为“1”，而 <code>ngx.req.get_uri_args[&quot;strider&quot;]</code> 的值为 <code>table [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]</code>。因此，<code>ngx.req.get_uri_args</code> 属于<code>ngx.var.arg_</code> 的增强。</p>
<p><code>ngx.var.arg_</code> 的实现是直接使用 Nginx 原生的变量支持，Nginx 相关代码为：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000">ngx_http_variable_value_t</span> *  
<span style="color:#000">ngx_http_get_variable</span>(<span style="color:#000">ngx_http_request_t</span> *<span style="color:#000">r</span>, <span style="color:#000">ngx_str_t</span> *<span style="color:#000">name</span>, <span style="color:#000">ngx_uint_t</span> <span style="color:#000">key</span>)  
{  
....(<span style="color:#f00">略</span><span style="color:#f00">）</span>....  
<span style="color:#00f">if</span> (<span style="color:#000">ngx_strncmp</span>(<span style="color:#000">name</span>-&gt;<span style="color:#000">data</span>, <span style="color:#5a2"></span><span style="color:#5a2">&#34;</span><span style="color:#5a2">arg_</span><span style="color:#5a2">&#34;</span>, <span style="color:#3af">4</span>) == <span style="color:#3af">0</span>) {  
  
        <span style="color:#00f">if</span> (<span style="color:#000">ngx_http_variable_argument</span>(<span style="color:#000">r</span>, <span style="color:#000">vv</span>, (<span style="color:#000">uintptr_t</span>) <span style="color:#000">name</span>) == <span style="color:#000">NGX_OK</span>) {  
            <span style="color:#00f">return</span> <span style="color:#000">vv</span>;  
        }  
  
        <span style="color:#00f">return</span> <span style="color:#000">NULL</span>;  
    }  
  
    <span style="color:#000">vv</span>-&gt;<span style="color:#000">not_found</span> = <span style="color:#3af">1</span>;  
  
    <span style="color:#00f">return</span> <span style="color:#000">vv</span>;  
}  
  
<span style="color:#00f">static</span> <span style="color:#000">ngx_int_t</span>  
<span style="color:#000">ngx_http_variable_argument</span>(<span style="color:#000">ngx_http_request_t</span> *<span style="color:#000">r</span>, <span style="color:#000">ngx_http_variable_value_t</span> *<span style="color:#000">v</span>,  
    <span style="color:#000">uintptr_t</span> <span style="color:#000">data</span>)  
{  
    <span style="color:#000">ngx_str_t</span> *<span style="color:#000">name</span> = (<span style="color:#000">ngx_str_t</span> *) <span style="color:#000">data</span>;  
  
    <span style="color:#000">u_char</span> *<span style="color:#000">arg</span>;  
    <span style="color:#000">size_t</span> <span style="color:#000">len</span>;  
    <span style="color:#000">ngx_str_t</span> <span style="color:#000">value</span>;  
  
    <span style="color:#000">len</span> = <span style="color:#000">name</span>-&gt;<span style="color:#000">len</span> - (<span style="color:#00f">sizeof</span>(<span style="color:#5a2"></span><span style="color:#5a2">&#34;</span><span style="color:#5a2">arg_</span><span style="color:#5a2">&#34;</span>) - <span style="color:#3af">1</span>);  
    <span style="color:#000">arg</span> = <span style="color:#000">name</span>-&gt;<span style="color:#000">data</span> + <span style="color:#00f">sizeof</span>(<span style="color:#5a2"></span><span style="color:#5a2">&#34;</span><span style="color:#5a2">arg_</span><span style="color:#5a2">&#34;</span>) - <span style="color:#3af">1</span>;  
  
    <span style="color:#00f">if</span> (<span style="color:#000">ngx_http_arg</span>(<span style="color:#000">r</span>, <span style="color:#000">arg</span>, <span style="color:#000">len</span>, &amp;<span style="color:#000">value</span>) != <span style="color:#000">NGX_OK</span>) {  
        <span style="color:#000">v</span>-&gt;<span style="color:#000">not_found</span> = <span style="color:#3af">1</span>;  
        <span style="color:#00f">return</span> <span style="color:#000">NGX_OK</span>;  
    }  
  
    <span style="color:#000">v</span>-&gt;<span style="color:#000">data</span> = <span style="color:#000">value</span>.<span style="color:#000">data</span>;  
    <span style="color:#000">v</span>-&gt;<span style="color:#000">len</span> = <span style="color:#000">value</span>.<span style="color:#000">len</span>;  
    <span style="color:#000">v</span>-&gt;<span style="color:#000">valid</span> = <span style="color:#3af">1</span>;  
    <span style="color:#000">v</span>-&gt;<span style="color:#000">no_cacheable</span> = <span style="color:#3af">0</span>;  
    <span style="color:#000">v</span>-&gt;<span style="color:#000">not_found</span> = <span style="color:#3af">0</span>;  
  
    <span style="color:#00f">return</span> <span style="color:#000">NGX_OK</span>;  
}  
  
<span style="color:#000">ngx_int_t</span>  
<span style="color:#000">ngx_http_arg</span>(<span style="color:#000">ngx_http_request_t</span> *<span style="color:#000">r</span>, <span style="color:#000">u_char</span> *<span style="color:#000">name</span>, <span style="color:#000">size_t</span> <span style="color:#000">len</span>, <span style="color:#000">ngx_str_t</span> *<span style="color:#000">value</span>)  
{  
    <span style="color:#000">u_char</span> *<span style="color:#000">p</span>, *<span style="color:#000">last</span>;  
  
    <span style="color:#00f">if</span> (<span style="color:#000">r</span>-&gt;<span style="color:#000">args</span>.<span style="color:#000">len</span> == <span style="color:#3af">0</span>) {  
        <span style="color:#00f">return</span> <span style="color:#000">NGX_DECLINED</span>;  
    }  
  
    <span style="color:#000">p</span> = <span style="color:#000">r</span>-&gt;<span style="color:#000">args</span>.<span style="color:#000">data</span>;  
    <span style="color:#000">last</span> = <span style="color:#000">p</span> + <span style="color:#000">r</span>-&gt;<span style="color:#000">args</span>.<span style="color:#000">len</span>;  
  
    <span style="color:#00f">for</span> ( <span style="color:#888;font-style:italic">/* void */</span> ; <span style="color:#000">p</span> &lt; <span style="color:#000">last</span>; <span style="color:#000">p</span>++) {  
  
        <span style="color:#888;font-style:italic">/* we need &#39;=&#39; after name, so drop one char from last */</span>  
  
        <span style="color:#000">p</span> = <span style="color:#000">ngx_strlcasestrn</span>(<span style="color:#000">p</span>, <span style="color:#000">last</span> - <span style="color:#3af">1</span>, <span style="color:#000">name</span>, <span style="color:#000">len</span> - <span style="color:#3af">1</span>);  
  
        <span style="color:#00f">if</span> (<span style="color:#000">p</span> == <span style="color:#000">NULL</span>) {  
            <span style="color:#00f">return</span> <span style="color:#000">NGX_DECLINED</span>;  
        }  
  
        <span style="color:#00f">if</span> ((<span style="color:#000">p</span> == <span style="color:#000">r</span>-&gt;<span style="color:#000">args</span>.<span style="color:#000">data</span> || *(<span style="color:#000">p</span> - <span style="color:#3af">1</span>) == <span style="color:#5a2"></span><span style="color:#5a2">&#39;</span><span style="color:#5a2">&amp;</span><span style="color:#5a2">&#39;</span>) &amp;&amp; *(<span style="color:#000">p</span> + <span style="color:#000">len</span>) == <span style="color:#5a2"></span><span style="color:#5a2">&#39;</span><span style="color:#5a2">=</span><span style="color:#5a2">&#39;</span>) {  
  
            <span style="color:#000">value</span>-&gt;<span style="color:#000">data</span> = <span style="color:#000">p</span> + <span style="color:#000">len</span> + <span style="color:#3af">1</span>;  
  
            <span style="color:#000">p</span> = <span style="color:#000">ngx_strlchr</span>(<span style="color:#000">p</span>, <span style="color:#000">last</span>, <span style="color:#5a2"></span><span style="color:#5a2">&#39;</span><span style="color:#5a2">&amp;</span><span style="color:#5a2">&#39;</span>);  
  
            <span style="color:#00f">if</span> (<span style="color:#000">p</span> == <span style="color:#000">NULL</span>) {  
                <span style="color:#000">p</span> = <span style="color:#000">r</span>-&gt;<span style="color:#000">args</span>.<span style="color:#000">data</span> + <span style="color:#000">r</span>-&gt;<span style="color:#000">args</span>.<span style="color:#000">len</span>;  
            }  
  
            <span style="color:#000">value</span>-&gt;<span style="color:#000">len</span> = <span style="color:#000">p</span> - <span style="color:#000">value</span>-&gt;<span style="color:#000">data</span>;  
  
            <span style="color:#00f">return</span> <span style="color:#000">NGX_OK</span>;  
        }  
    }  
  
    <span style="color:#00f">return</span> <span style="color:#000">NGX_DECLINED</span>;  
}  
</code></pre></div></div>

  </article>
</main>
<footer>
  <div>
    <div>2011-2020 strider. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
