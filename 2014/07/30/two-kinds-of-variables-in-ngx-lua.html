<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="strider (方鹏)">
<meta name="description" content="一个伪文青兼程序员的自嗨
    ">
<meta name="keywords" content="博客, 技术, 文学, 电影">
<meta name="referrer" content="always">
<title>ngx.var.arg与ngx.req.get_uri_args的区别 - 纯真年代</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://pureage.info/">纯真年代</a></h1><h2><a href="https://pureage.info/">阅读、体验、沉淀...</a></h2>
  </div>
  <nav><a href="/">博客</a><a href="/tools/">工具</a><a href="/about/">关于</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>ngx.var.arg与ngx.req.get_uri_args的区别</h1>
  </div>
<div class="meta">
  <div>2014-07-30</div>
  <div>
    <span><a href="/tags/nginx">#nginx</a></span>
    </div>
  </div>
<div class="content">
  <p>ngx.var.arg_xx与ngx.req.get_uri_args[&ldquo;xx&rdquo;]两者都是为了获取请求uri中的参数，例如</p>
<pre><code>http://pureage.info?strider=1  
</code></pre><p>为了获取输入参数strider，以下两种方法都可以：</p>
<ol>
<li>
<p>local strider = ngx.var.arg_strider</p>
</li>
<li>
<p>local strider = ngx.req.get_uri_args[&ldquo;strider&rdquo;]</p>
</li>
</ol>
<p>差别在于，当请求uri中有多个同名参数时,ngx.var.arg_xx的做法是取第一个出现的值,ngx.req_get_uri_args[&ldquo;xx&rdquo;]的做法是返回一个table，该table里存放了该参数的所有值，例如,当请求uri为：</p>
<pre><code>http://pureage.info?strider=1&amp;strider=2&amp;strider=3&amp;strider=4  
</code></pre><p>时，ngx.var.arg_strider的值为&quot;1&rdquo;,而ngx.req.get_uri_args[&ldquo;strider&rdquo;]的值为table [&ldquo;1&rdquo;, &ldquo;2&rdquo;, &ldquo;3&rdquo;, &ldquo;4&rdquo;]。因此，ngx.req.get_uri_args属于ngx.var.arg_的增强。</p>
<p>ngx.var.arg_的实现是直接使用nginx原生的变量支持，nginx相关代码为：</p>
<pre><code>ngx_http_variable_value_t *  
ngx_http_get_variable(ngx_http_request_t *r, ngx_str_t *name, ngx_uint_t key)  
{  
....(略）....  
if (ngx_strncmp(name-&gt;data, &quot;arg_&quot;, 4) == 0) {  
  
        if (ngx_http_variable_argument(r, vv, (uintptr_t) name) == NGX_OK) {  
            return vv;  
        }  
  
        return NULL;  
    }  
  
    vv-&gt;not_found = 1;  
  
    return vv;  
}  
  
static ngx_int_t  
ngx_http_variable_argument(ngx_http_request_t *r, ngx_http_variable_value_t *v,  
    uintptr_t data)  
{  
    ngx_str_t *name = (ngx_str_t *) data;  
  
    u_char *arg;  
    size_t len;  
    ngx_str_t value;  
  
    len = name-&gt;len - (sizeof(&quot;arg_&quot;) - 1);  
    arg = name-&gt;data + sizeof(&quot;arg_&quot;) - 1;  
  
    if (ngx_http_arg(r, arg, len, &amp;value) != NGX_OK) {  
        v-&gt;not_found = 1;  
        return NGX_OK;  
    }  
  
    v-&gt;data = value.data;  
    v-&gt;len = value.len;  
    v-&gt;valid = 1;  
    v-&gt;no_cacheable = 0;  
    v-&gt;not_found = 0;  
  
    return NGX_OK;  
}  
  
ngx_int_t  
ngx_http_arg(ngx_http_request_t *r, u_char *name, size_t len, ngx_str_t *value)  
{  
    u_char *p, *last;  
  
    if (r-&gt;args.len == 0) {  
        return NGX_DECLINED;  
    }  
  
    p = r-&gt;args.data;  
    last = p + r-&gt;args.len;  
  
    for ( /* void */ ; p &lt; last; p++) {  
  
        /* we need '=' after name, so drop one char from last */  
  
        p = ngx_strlcasestrn(p, last - 1, name, len - 1);  
  
        if (p == NULL) {  
            return NGX_DECLINED;  
        }  
  
        if ((p == r-&gt;args.data || *(p - 1) == '&amp;') &amp;&amp; *(p + len) == '=') {  
  
            value-&gt;data = p + len + 1;  
  
            p = ngx_strlchr(p, last, '&amp;');  
  
            if (p == NULL) {  
                p = r-&gt;args.data + r-&gt;args.len;  
            }  
  
            value-&gt;len = p - value-&gt;data;  
  
            return NGX_OK;  
        }  
    }  
  
    return NGX_DECLINED;  
}  
</code></pre></div>

  </article>
</main>
<footer>
  <div>
    <div>
      2011-2020 strider. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
