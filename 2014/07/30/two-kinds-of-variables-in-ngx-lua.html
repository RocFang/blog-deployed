<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>ngx.var.arg与ngx.req.get_uri_args的区别 - 纯真年代</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="ngx.var.arg与ngx.req.get_uri_args的区别" />
<meta property="og:description" content="ngx.var.arg_xx与ngx.req.get_uri_args[&ldquo;xx&rdquo;]两者都是为了获取请求uri中的参数，例如
http://pureage.info?strider=1  
为了获取输入参数strider，以下两种方法都可以：


local strider = ngx.var.arg_strider

local strider = ngx.req.get_uri_args[&ldquo;strider&rdquo;]


差别在于，当请求uri中有多个同名参数时,ngx.var.arg_xx的做法是取第一个出现的值,ngx.req_get_uri_args[&ldquo;xx&rdquo;]的做法是返回一个table，该table里存放了该参数的所有值，例如,当请求uri为：
http://pureage.info?strider=1&amp;strider=2&amp;strider=3&amp;strider=4  
时，ngx.var.arg_strider的值为&rdquo;1&rdquo;,而ngx.req.get_uri_args[&ldquo;strider&rdquo;]的值为table [&ldquo;1&rdquo;, &ldquo;2&rdquo;, &ldquo;3&rdquo;, &ldquo;4&rdquo;]。因此，ngx.req.get_uri_args属于ngx.var.arg_的增强。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pureage.info/2014/07/30/two-kinds-of-variables-in-ngx-lua.html" />
<meta property="article:published_time" content="2014-07-30T10:30:00&#43;00:00"/>
<meta property="article:modified_time" content="2014-07-30T10:30:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ngx.var.arg与ngx.req.get_uri_args的区别"/>
<meta name="twitter:description" content="ngx.var.arg_xx与ngx.req.get_uri_args[&ldquo;xx&rdquo;]两者都是为了获取请求uri中的参数，例如
http://pureage.info?strider=1  
为了获取输入参数strider，以下两种方法都可以：


local strider = ngx.var.arg_strider

local strider = ngx.req.get_uri_args[&ldquo;strider&rdquo;]


差别在于，当请求uri中有多个同名参数时,ngx.var.arg_xx的做法是取第一个出现的值,ngx.req_get_uri_args[&ldquo;xx&rdquo;]的做法是返回一个table，该table里存放了该参数的所有值，例如,当请求uri为：
http://pureage.info?strider=1&amp;strider=2&amp;strider=3&amp;strider=4  
时，ngx.var.arg_strider的值为&rdquo;1&rdquo;,而ngx.req.get_uri_args[&ldquo;strider&rdquo;]的值为table [&ldquo;1&rdquo;, &ldquo;2&rdquo;, &ldquo;3&rdquo;, &ldquo;4&rdquo;]。因此，ngx.req.get_uri_args属于ngx.var.arg_的增强。"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title">纯真年代</h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">首页</a>
			</li>
			
			<li>
				<a href="/posts">归档</a>
			</li>
			
			<li>
				<a href="/about">关于</a>
			</li>
			
			<li>
				<a href="/tags">标签</a>
			</li>
			
			<li>
				<a href="/tags">工具</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">ngx.var.arg与ngx.req.get_uri_args的区别</h1>
			<div class="meta">Posted at &mdash; Jul 30, 2014</div>
		</div>

		<div class="markdown">
			<p>ngx.var.arg_xx与ngx.req.get_uri_args[&ldquo;xx&rdquo;]两者都是为了获取请求uri中的参数，例如</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">http://pureage.info?strider=1  </pre></div>
<p>为了获取输入参数strider，以下两种方法都可以：</p>

<ol>
<li><p>local strider = ngx.var.arg_strider</p></li>

<li><p>local strider = ngx.req.get_uri_args[&ldquo;strider&rdquo;]</p></li>
</ol>

<p>差别在于，当请求uri中有多个同名参数时,ngx.var.arg_xx的做法是取第一个出现的值,ngx.req_get_uri_args[&ldquo;xx&rdquo;]的做法是返回一个table，该table里存放了该参数的所有值，例如,当请求uri为：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">http://pureage.info?strider=1&amp;strider=2&amp;strider=3&amp;strider=4  </pre></div>
<p>时，ngx.var.arg_strider的值为&rdquo;1&rdquo;,而ngx.req.get_uri_args[&ldquo;strider&rdquo;]的值为table [&ldquo;1&rdquo;, &ldquo;2&rdquo;, &ldquo;3&rdquo;, &ldquo;4&rdquo;]。因此，ngx.req.get_uri_args属于ngx.var.arg_的增强。</p>

<p>ngx.var.arg_的实现是直接使用nginx原生的变量支持，nginx相关代码为：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">ngx_http_variable_value_t *  
ngx_http_get_variable(ngx_http_request_t *r, ngx_str_t *name, ngx_uint_t key)  
{  
....(略）....  
if (ngx_strncmp(name-&gt;data, &#34;arg_&#34;, 4) == 0) {  
  
        if (ngx_http_variable_argument(r, vv, (uintptr_t) name) == NGX_OK) {  
            return vv;  
        }  
  
        return NULL;  
    }  
  
    vv-&gt;not_found = 1;  
  
    return vv;  
}  
  
static ngx_int_t  
ngx_http_variable_argument(ngx_http_request_t *r, ngx_http_variable_value_t *v,  
    uintptr_t data)  
{  
    ngx_str_t *name = (ngx_str_t *) data;  
  
    u_char *arg;  
    size_t len;  
    ngx_str_t value;  
  
    len = name-&gt;len - (sizeof(&#34;arg_&#34;) - 1);  
    arg = name-&gt;data + sizeof(&#34;arg_&#34;) - 1;  
  
    if (ngx_http_arg(r, arg, len, &amp;value) != NGX_OK) {  
        v-&gt;not_found = 1;  
        return NGX_OK;  
    }  
  
    v-&gt;data = value.data;  
    v-&gt;len = value.len;  
    v-&gt;valid = 1;  
    v-&gt;no_cacheable = 0;  
    v-&gt;not_found = 0;  
  
    return NGX_OK;  
}  
  
ngx_int_t  
ngx_http_arg(ngx_http_request_t *r, u_char *name, size_t len, ngx_str_t *value)  
{  
    u_char *p, *last;  
  
    if (r-&gt;args.len == 0) {  
        return NGX_DECLINED;  
    }  
  
    p = r-&gt;args.data;  
    last = p + r-&gt;args.len;  
  
    for ( /* void */ ; p &lt; last; p++) {  
  
        /* we need &#39;=&#39; after name, so drop one char from last */  
  
        p = ngx_strlcasestrn(p, last - 1, name, len - 1);  
  
        if (p == NULL) {  
            return NGX_DECLINED;  
        }  
  
        if ((p == r-&gt;args.data || *(p - 1) == &#39;&amp;&#39;) &amp;&amp; *(p + len) == &#39;=&#39;) {  
  
            value-&gt;data = p + len + 1;  
  
            p = ngx_strlchr(p, last, &#39;&amp;&#39;);  
  
            if (p == NULL) {  
                p = r-&gt;args.data + r-&gt;args.len;  
            }  
  
            value-&gt;len = p - value-&gt;data;  
  
            return NGX_OK;  
        }  
    }  
  
    return NGX_DECLINED;  
}  </pre></div>
		</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = '';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div><a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


</body>
</html>
