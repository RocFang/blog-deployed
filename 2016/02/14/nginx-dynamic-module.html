<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="strider (方鹏)">
<meta name="description" content="一个伪文青兼程序员的自嗨
    ">
<meta name="keywords" content="博客, 技术, 文学, 电影">
<meta name="referrer" content="always">
<title>关于 Nginx-1.9.11 的动态模块 - 纯真年代</title>
<link rel="stylesheet" type="text/css" href="/css/main.css">
<link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
<header>
  <div>
    <h1><a href="https://pureage.info/">纯真年代</a></h1><h2><a href="https://pureage.info/">阅读、体验、沉淀...</a></h2>
  </div>
  <nav><a href="/">博客</a><a href="/tools/">工具</a><a href="/about/">关于</a></nav>
</header>
<main>
  <article>
    <div class="title">
  <h1>关于 Nginx-1.9.11 的动态模块</h1>
  </div>
<div class="meta">
  <div>2016-02-14</div>
  <div>
    <span><a href="/tags/nginx">#nginx</a></span>
    </div>
  </div>
<div class="content">
  <p>我们知道，原生 Nginx 增加、修改一个第三方模块，需要重新编译源代码，所有的模块都是用静态链接的形式组织起来的。而 Tengine 有一个增强的功能，即动态模块加载 DSO(Dynamic Shared Objects)，可以实现运行时动态加载模块，而不用每次都要重新编译Tengine。</p>
<p>在 2016 年农历春节期间，Nginx 官方发布了最新版本 Nginx-1.9.11，也增加了该功能。</p>
<p>Nginx-1.9.11 的Changelog 如下:</p>
<blockquote>
<p>Changes with nginx 1.9.11                                        09 Feb 2016</p>
<p>*) Feature: TCP support in resolver.</p>
<p>*) Feature: dynamic modules.</p>
<p>*) Bugfix: the $request_length variable did not include size of request<br>
headers when using HTTP/2.</p>
<p>*) Bugfix: in the ngx_http_v2_module.</p>
</blockquote>
<p>从使用的角度上来说，是增加了一个指令 <a href="http://nginx.org/en/docs/ngx_core_module.html#load_module">load_modules</a> 指令，来加载编译为 so 形式的动态模块。</p>
<p>该功能的实现还是挺简单的，主要包括如下几个方面：</p>
<ul>
<li>将模块相关的类型定义和操作方法调整到新的文件 ngx_module.h 和 ngx_module.c 中</li>
<li>添加 dlopen 的封装</li>
<li>调整编译脚本</li>
<li>少量 Nginx 核心代码的调整。主要是为 cycle 新增了一个成员modules，用来取代之前的全局变量 ngx_modules，并将之前初始化时对于 ngx_modules 的操作封装成几个函数，放在 init_cycle 里调用。</li>
</ul>
<p>我认为我们需要重点关注的是如下几个：</p>
<ul>
<li>编译脚本有了较大的变化，在以后的模块编程中，尽量要让自己的模块能够静态链接和动态链接。这就需要适应一下新的编译框架。</li>
<li>不光旧的模块需要考虑兼容性，新的模块也要考虑对于旧的 Nginx 版本的兼容性。这包括两个方面，一个是 c 语言层面，要关注动态模块对于 Nginx 框架的调整，例如之前凡是用到全局变量 ngx_modules 的地方，要修改为 cycle-&gt;modules，当然正确的做法应该是用宏开关来判断当前 Nginx 版本是否大于 1.9.11 来决定是否调整；另一个是编译脚本，也需要判断版本，从而做出一些开关的选择，重点是对 ngx_module_link 变量的判断。</li>
</ul>
<p>举个例子，对于 nginx-rtmp 模块，我们要将其修改为既能在 Nginx-1.9.11 及其以后的版本中，同时支持静态链接(<code>--add-module</code>)和动态链接(<code>--add-dynamic-module</code>)，又要让其在老的版本中依然能支持旧的编译框架下的静态链接(<code>--add-module</code>)。</p>
<p>为了达到这个目的，我做了如下测试，首先将 nginx-rtmp 的 congfig 文件修改为:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000">ngx_addon_name</span>=<span style="color:#5a2">&#34;ngx_rtmp_module&#34;</span>  
<span style="color:#000">RTMP_CORE_MODULES</span>=<span style="color:#5a2">&#34;ngx_rtmp_module                             \  
</span><span style="color:#5a2">                   ngx_rtmp_core_module                        \  
</span><span style="color:#5a2">                   ngx_rtmp_cmd_module                         \  
</span><span style="color:#5a2">                   ngx_rtmp_codec_module                       \  
</span><span style="color:#5a2">                   ngx_rtmp_access_module                      \  
</span><span style="color:#5a2">                   ngx_rtmp_record_module                      \  
</span><span style="color:#5a2">                   ngx_rtmp_live_module                        \  
</span><span style="color:#5a2">                   ngx_rtmp_play_module                        \  
</span><span style="color:#5a2">                   ngx_rtmp_flv_module                         \  
</span><span style="color:#5a2">                   ngx_rtmp_mp4_module                         \  
</span><span style="color:#5a2">                   ngx_rtmp_netcall_module                     \  
</span><span style="color:#5a2">                   ngx_rtmp_relay_module                       \  
</span><span style="color:#5a2">                   ngx_rtmp_exec_module                        \  
</span><span style="color:#5a2">                   ngx_rtmp_auto_push_module                   \  
</span><span style="color:#5a2">                   ngx_rtmp_notify_module                      \  
</span><span style="color:#5a2">                   ngx_rtmp_log_module                         \  
</span><span style="color:#5a2">                   ngx_rtmp_limit_module                       \  
</span><span style="color:#5a2">                   ngx_rtmp_hls_module                         \  
</span><span style="color:#5a2">                   ngx_rtmp_dash_module                        \  
</span><span style="color:#5a2">                   &#34;</span>  
<span style="color:#000">RTMP_HTTP_MODULES</span>=<span style="color:#5a2">&#34;ngx_rtmp_stat_module                        \  
</span><span style="color:#5a2">                   ngx_rtmp_control_module                        \  
</span><span style="color:#5a2">                  &#34;</span>  
<span style="color:#000">RTMP_DEPS</span>=<span style="color:#5a2">&#34;</span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_amf.h               \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_bandwidth.h         \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_cmd_module.h        \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_codec_module.h      \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_eval.h              \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp.h                   \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_version.h           \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_live_module.h       \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_netcall_module.h    \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_play_module.h       \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_record_module.h     \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_relay_module.h      \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_streams.h           \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_bitop.h             \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_proxy_protocol.h    \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/hls/ngx_rtmp_mpegts.h        \  
</span><span style="color:#5a2">           </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/dash/ngx_rtmp_mp4.h          \  
</span><span style="color:#5a2">           </span><span style="color:#5a2">&#34;</span>  
<span style="color:#000">RTMP_CORE_SRCS</span>=<span style="color:#5a2">&#34;</span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp.c                   \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_init.c              \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_handshake.c         \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_handler.c           \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_amf.c               \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_send.c              \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_shared.c            \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_eval.c              \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_receive.c           \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_core_module.c       \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_cmd_module.c        \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_codec_module.c      \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_access_module.c     \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_record_module.c     \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_live_module.c       \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_play_module.c       \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_flv_module.c        \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_mp4_module.c        \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_netcall_module.c    \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_relay_module.c      \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_bandwidth.c         \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_exec_module.c       \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_auto_push_module.c  \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_notify_module.c     \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_log_module.c        \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_limit_module.c      \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_bitop.c             \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_proxy_protocol.c    \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/hls/ngx_rtmp_hls_module.c    \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/dash/ngx_rtmp_dash_module.c  \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/hls/ngx_rtmp_mpegts.c        \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/dash/ngx_rtmp_mp4.c          \  
</span><span style="color:#5a2">                </span><span style="color:#5a2">&#34;</span>  
<span style="color:#000">RTMP_HTTP_SRCS</span>=<span style="color:#5a2">&#34;</span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_stat_module.c       \  
</span><span style="color:#5a2">                </span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">/ngx_rtmp_control_module.c    \  
</span><span style="color:#5a2">                </span><span style="color:#5a2">&#34;</span>  
  
<span style="color:#888;font-style:italic">#nginx version &gt;= 1.9.11</span>  
<span style="color:#00f">if</span> <span style="color:#000">test</span> -n <span style="color:#5a2">&#34;</span><span style="color:#000">$ngx_module_link</span><span style="color:#5a2">&#34;</span>; <span style="color:#00f">then</span>  
    <span style="color:#000">ngx_module_incs</span>=<span style="color:#000">$ngx_addon_dir</span>  
    <span style="color:#000">ngx_module_deps</span>=<span style="color:#000">$RTMP_DEPS</span>  
    <span style="color:#00f">if</span> [ <span style="color:#000">$ngx_module_link</span> = DYNAMIC ] ; <span style="color:#00f">then</span>  
        <span style="color:#000">ngx_module_name</span>=<span style="color:#5a2">&#34;</span><span style="color:#000">$RTMP_CORE_MODULES</span><span style="color:#5a2"> </span><span style="color:#000">$RTMP_HTTP_MODULES</span><span style="color:#5a2">&#34;</span>  
        <span style="color:#000">ngx_module_srcs</span>=<span style="color:#5a2">&#34;</span><span style="color:#000">$RTMP_CORE_SRCS</span><span style="color:#5a2"> </span><span style="color:#000">$RTMP_HTTP_SRCS</span><span style="color:#5a2">&#34;</span>  
        . auto/module  
    <span style="color:#00f">elif</span> [ <span style="color:#000">$ngx_module_link</span> = ADDON ] ; <span style="color:#00f">then</span>  
        <span style="color:#000">ngx_module_type</span>=CORE  
        <span style="color:#000">ngx_module_name</span>=<span style="color:#000">$RTMP_CORE_MODULES</span>  
        <span style="color:#000">ngx_module_srcs</span>=<span style="color:#000">$RTMP_CORE_SRCS</span>  
        . auto/module  
        <span style="color:#000">ngx_module_type</span>=HTTP  
        <span style="color:#000">ngx_module_name</span>=<span style="color:#000">$RTMP_HTTP_MODULES</span>  
        <span style="color:#000">ngx_module_srcs</span>=<span style="color:#000">$RTMP_HTTP_SRCS</span>  
        . auto/module  
    <span style="color:#00f">fi</span>  
  
<span style="color:#888;font-style:italic">#nginx version &lt; 1.9.11</span>  
<span style="color:#00f">else</span>  
    <span style="color:#000">CORE_MODULES</span>=<span style="color:#5a2">&#34;</span><span style="color:#000">$CORE_MODULES</span><span style="color:#5a2">  
</span><span style="color:#5a2">                  </span><span style="color:#000">$RTMP_CORE_MODULES</span><span style="color:#5a2">&#34;</span>  
    <span style="color:#000">HTTP_MODULES</span>=<span style="color:#5a2">&#34;</span><span style="color:#000">$HTTP_MODULES</span><span style="color:#5a2">  
</span><span style="color:#5a2">                  </span><span style="color:#000">$RTMP_HTTP_MODULES</span><span style="color:#5a2">&#34;</span>  
    <span style="color:#000">NGX_ADDON_DEPS</span>=<span style="color:#5a2">&#34;</span><span style="color:#000">$NGX_ADDON_DEPS</span><span style="color:#5a2"> \  
</span><span style="color:#5a2">                    </span><span style="color:#000">$RTMP_DEPS</span><span style="color:#5a2">&#34;</span>  
    <span style="color:#000">NGX_ADDON_SRCS</span>=<span style="color:#5a2">&#34;</span><span style="color:#000">$NGX_ADDON_SRCS</span><span style="color:#5a2">  
</span><span style="color:#5a2">                    </span><span style="color:#000">$RTMP_CORE_SRCS</span><span style="color:#5a2">  
</span><span style="color:#5a2">                    </span><span style="color:#000">$RTMP_HTTP_SRCS</span><span style="color:#5a2">&#34;</span>  
    <span style="color:#000">CFLAGS</span>=<span style="color:#5a2">&#34;</span><span style="color:#000">$CFLAGS</span><span style="color:#5a2"> -I</span><span style="color:#000">$ngx_addon_dir</span><span style="color:#5a2">&#34;</span>  
<span style="color:#00f">fi</span>  
  
<span style="color:#000">USE_OPENSSL</span>=YES  
</code></pre></div><p>然后调整所有 c 源文件里使用 ngx_modules 的地方，可以添加类似如下的代码片段：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#888;font-style:italic">#</span><span style="color:#888;font-style:italic">if defined(nginx_version) &amp;&amp; nginx_version &gt;= 1009011  </span><span style="color:#888;font-style:italic">
</span><span style="color:#888;font-style:italic"></span>    <span style="color:#000">modules</span> = <span style="color:#000">cf</span>-&gt;<span style="color:#000">cycle</span>-&gt;<span style="color:#000">modules</span>;  
<span style="color:#888;font-style:italic">#</span><span style="color:#888;font-style:italic">else  </span><span style="color:#888;font-style:italic">
</span><span style="color:#888;font-style:italic"></span>    <span style="color:#000">modules</span> = <span style="color:#000">ngx_modules</span>;  
<span style="color:#888;font-style:italic">#</span><span style="color:#888;font-style:italic">endif  </span><span style="color:#888;font-style:italic">
</span></code></pre></div><p>这样就可以达到我们的目的了。</p>
<p>具体关于编译脚本的调整，我们参考一下官方的几个文档即可：</p>
<ul>
<li><a href="https://www.nginx.com/resources/wiki/extending/converting/">Converting Static Modules to Dynamic Modules</a></li>
<li><a href="https://www.nginx.com/resources/wiki/extending/new_config/">New Config Shell File</a></li>
<li><a href="https://www.nginx.com/resources/wiki/extending/old_config/">Old Config Shell File</a></li>
</ul>
<p>注意，上面的文档中，关于 rtmp 模块的调整，是有问题的，一方面如果那些使用了 ngx_modules 全局变量的 c 文件不相应修改的话，运行时会有段错误；另一方面，示例里对 config 文件的调整，只能保证对于 Nginx-1.9.11 及其以后的版本能同时支持编译为动态模块和静态模块，却对 Nginx-1.9.11 之前的版本的支持有问题。</p></div>

  </article>
</main>
<footer>
  <div>
    <div>2011-2020 strider. <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC-BY-4.0</a></div>
  </div>
</footer>
</body>
</html>
