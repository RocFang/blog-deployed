<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>关于Nginx-1.9.11的动态模块 - 纯真年代</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="关于Nginx-1.9.11的动态模块" />
<meta property="og:description" content="我们知道，原生 Nginx 增加、修改一个第三方模块，需要重新编译源代码，所有的模块都是用静态链接的形式组织起来的。而 Tengine 有一个增强的功能，即动态模块加载 DSO(Dynamic Shared Objects), 可以实现运行时动态加载模块，而不用每次都要重新编译Tengine。

在 2016 年农历春节期间，Nginx 官方发布了最新版本 Nginx-1.9.11，也增加了该功能。

Nginx-1.9.11 的Changelog 如下:


Changes with nginx 1.9.11                                        09 Feb 2016

*) Feature: TCP support in resolver.

*) Feature: dynamic modules.

*) Bugfix: the $request_length variable did not include size of request
      headers when using HTTP/2.

*) Bugfix: in the ngx_http_v2_module.


从使用的角度上来说，是增加了一个指令 load_modules 指令，来加载编译为 so 形式的动态模块。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pureage.info/2016/02/14/nginx-dynamic-module.html" />
<meta property="article:published_time" content="2016-02-14T14:57:00&#43;00:00"/>
<meta property="article:modified_time" content="2016-02-14T14:57:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="关于Nginx-1.9.11的动态模块"/>
<meta name="twitter:description" content="我们知道，原生 Nginx 增加、修改一个第三方模块，需要重新编译源代码，所有的模块都是用静态链接的形式组织起来的。而 Tengine 有一个增强的功能，即动态模块加载 DSO(Dynamic Shared Objects), 可以实现运行时动态加载模块，而不用每次都要重新编译Tengine。

在 2016 年农历春节期间，Nginx 官方发布了最新版本 Nginx-1.9.11，也增加了该功能。

Nginx-1.9.11 的Changelog 如下:


Changes with nginx 1.9.11                                        09 Feb 2016

*) Feature: TCP support in resolver.

*) Feature: dynamic modules.

*) Bugfix: the $request_length variable did not include size of request
      headers when using HTTP/2.

*) Bugfix: in the ngx_http_v2_module.


从使用的角度上来说，是增加了一个指令 load_modules 指令，来加载编译为 so 形式的动态模块。"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title">纯真年代</h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">首页</a>
			</li>
			
			<li>
				<a href="/posts">归档</a>
			</li>
			
			<li>
				<a href="/about">关于</a>
			</li>
			
			<li>
				<a href="/tags">标签</a>
			</li>
			
			<li>
				<a href="/tags">工具</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">关于Nginx-1.9.11的动态模块</h1>
			<div class="meta">Posted at &mdash; Feb 14, 2016</div>
		</div>

		<div class="markdown">
			<p>我们知道，原生 Nginx 增加、修改一个第三方模块，需要重新编译源代码，所有的模块都是用静态链接的形式组织起来的。而 Tengine 有一个增强的功能，即动态模块加载 DSO(Dynamic Shared Objects), 可以实现运行时动态加载模块，而不用每次都要重新编译Tengine。</p>

<p>在 2016 年农历春节期间，Nginx 官方发布了最新版本 Nginx-1.9.11，也增加了该功能。</p>

<p>Nginx-1.9.11 的Changelog 如下:</p>

<blockquote>
<p>Changes with nginx 1.9.11                                        09 Feb 2016</p>

<p>*) Feature: TCP support in resolver.</p>

<p>*) Feature: dynamic modules.</p>

<p>*) Bugfix: the $request_length variable did not include size of request<br />
      headers when using HTTP/2.</p>

<p>*) Bugfix: in the ngx_http_v2_module.</p>
</blockquote>

<p>从使用的角度上来说，是增加了一个指令 <a href="http://nginx.org/en/docs/ngx_core_module.html#load_module">load_modules</a> 指令，来加载编译为 so 形式的动态模块。</p>

<p>该功能的实现还是挺简单的，主要包括如下几个方面:</p>

<ul>
<li>将模块相关的类型定义和操作方法调整到新的文件 ngx_module.h 和 ngx_module.c 中<br /></li>
<li>添加 dlopen 的封装<br /></li>
<li>调整编译脚本<br /></li>
<li>少量 Nginx 核心代码的调整。主要是为 cycle 新增了一个成员modules, 用来取代之前的全局变量 ngx_modules, 并将之前初始化时对于 ngx_modules 的操作封装成几个函数，放在 init_cycle 里调用。<br />
<br /></li>
</ul>

<p>我认为我们需要重点关注的是如下几个:</p>

<ul>
<li>编译脚本有了较大的变化，在以后的模块编程中，尽量要让自己的模块能够静态链接和动态链接。这就需要适应一下新的编译框架。<br /></li>
<li>不光旧的模块需要考虑兼容性，新的模块也要考虑对于旧的 Nginx 版本的兼容性。这包括两个方面，一个是 c 语言层面，要关注动态模块对于 Nginx 框架的调整，例如之前凡是用到全局变量 ngx_modules 的地方，要修改为 cycle-&gt;modules，当然正确的做法应该是用宏开关来判断当前 Nginx 版本是否大于 1.9.11 来决定是否调整；另一个是编译脚本，也需要判断版本，从而做出一些开关的选择，重点是对 ngx_module_link 变量的判断。<br />
<br /></li>
</ul>

<p>举个例子，对于 nginx-rtmp 模块，我们要将其修改为既能在 Nginx-1.9.11 及其以后的版本中，同时支持静态链接(&ndash;add-module)和动态链接(&ndash;add-dynamic-module)，又要让其在老的版本中依然能支持旧的编译框架下的静态链接(&ndash;add-module)。</p>

<p>为了达到这个目的，我做了如下测试，首先将 nginx-rtmp 的 congfig 文件修改为:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">ngx_addon_name=&#34;ngx_rtmp_module&#34;  
RTMP_CORE_MODULES=&#34;ngx_rtmp_module                             \  
                   ngx_rtmp_core_module                        \  
                   ngx_rtmp_cmd_module                         \  
                   ngx_rtmp_codec_module                       \  
                   ngx_rtmp_access_module                      \  
                   ngx_rtmp_record_module                      \  
                   ngx_rtmp_live_module                        \  
                   ngx_rtmp_play_module                        \  
                   ngx_rtmp_flv_module                         \  
                   ngx_rtmp_mp4_module                         \  
                   ngx_rtmp_netcall_module                     \  
                   ngx_rtmp_relay_module                       \  
                   ngx_rtmp_exec_module                        \  
                   ngx_rtmp_auto_push_module                   \  
                   ngx_rtmp_notify_module                      \  
                   ngx_rtmp_log_module                         \  
                   ngx_rtmp_limit_module                       \  
                   ngx_rtmp_hls_module                         \  
                   ngx_rtmp_dash_module                        \  
                   &#34;  
RTMP_HTTP_MODULES=&#34;ngx_rtmp_stat_module                        \  
                   ngx_rtmp_control_module                        \  
                  &#34;  
RTMP_DEPS=&#34;$ngx_addon_dir/ngx_rtmp_amf.h               \  
           $ngx_addon_dir/ngx_rtmp_bandwidth.h         \  
           $ngx_addon_dir/ngx_rtmp_cmd_module.h        \  
           $ngx_addon_dir/ngx_rtmp_codec_module.h      \  
           $ngx_addon_dir/ngx_rtmp_eval.h              \  
           $ngx_addon_dir/ngx_rtmp.h                   \  
           $ngx_addon_dir/ngx_rtmp_version.h           \  
           $ngx_addon_dir/ngx_rtmp_live_module.h       \  
           $ngx_addon_dir/ngx_rtmp_netcall_module.h    \  
           $ngx_addon_dir/ngx_rtmp_play_module.h       \  
           $ngx_addon_dir/ngx_rtmp_record_module.h     \  
           $ngx_addon_dir/ngx_rtmp_relay_module.h      \  
           $ngx_addon_dir/ngx_rtmp_streams.h           \  
           $ngx_addon_dir/ngx_rtmp_bitop.h             \  
           $ngx_addon_dir/ngx_rtmp_proxy_protocol.h    \  
           $ngx_addon_dir/hls/ngx_rtmp_mpegts.h        \  
           $ngx_addon_dir/dash/ngx_rtmp_mp4.h          \  
           &#34;  
RTMP_CORE_SRCS=&#34;$ngx_addon_dir/ngx_rtmp.c                   \  
                $ngx_addon_dir/ngx_rtmp_init.c              \  
                $ngx_addon_dir/ngx_rtmp_handshake.c         \  
                $ngx_addon_dir/ngx_rtmp_handler.c           \  
                $ngx_addon_dir/ngx_rtmp_amf.c               \  
                $ngx_addon_dir/ngx_rtmp_send.c              \  
                $ngx_addon_dir/ngx_rtmp_shared.c            \  
                $ngx_addon_dir/ngx_rtmp_eval.c              \  
                $ngx_addon_dir/ngx_rtmp_receive.c           \  
                $ngx_addon_dir/ngx_rtmp_core_module.c       \  
                $ngx_addon_dir/ngx_rtmp_cmd_module.c        \  
                $ngx_addon_dir/ngx_rtmp_codec_module.c      \  
                $ngx_addon_dir/ngx_rtmp_access_module.c     \  
                $ngx_addon_dir/ngx_rtmp_record_module.c     \  
                $ngx_addon_dir/ngx_rtmp_live_module.c       \  
                $ngx_addon_dir/ngx_rtmp_play_module.c       \  
                $ngx_addon_dir/ngx_rtmp_flv_module.c        \  
                $ngx_addon_dir/ngx_rtmp_mp4_module.c        \  
                $ngx_addon_dir/ngx_rtmp_netcall_module.c    \  
                $ngx_addon_dir/ngx_rtmp_relay_module.c      \  
                $ngx_addon_dir/ngx_rtmp_bandwidth.c         \  
                $ngx_addon_dir/ngx_rtmp_exec_module.c       \  
                $ngx_addon_dir/ngx_rtmp_auto_push_module.c  \  
                $ngx_addon_dir/ngx_rtmp_notify_module.c     \  
                $ngx_addon_dir/ngx_rtmp_log_module.c        \  
                $ngx_addon_dir/ngx_rtmp_limit_module.c      \  
                $ngx_addon_dir/ngx_rtmp_bitop.c             \  
                $ngx_addon_dir/ngx_rtmp_proxy_protocol.c    \  
                $ngx_addon_dir/hls/ngx_rtmp_hls_module.c    \  
                $ngx_addon_dir/dash/ngx_rtmp_dash_module.c  \  
                $ngx_addon_dir/hls/ngx_rtmp_mpegts.c        \  
                $ngx_addon_dir/dash/ngx_rtmp_mp4.c          \  
                &#34;  
RTMP_HTTP_SRCS=&#34;$ngx_addon_dir/ngx_rtmp_stat_module.c       \  
                $ngx_addon_dir/ngx_rtmp_control_module.c    \  
                &#34;  
  
#nginx version &gt;= 1.9.11  
if test -n &#34;$ngx_module_link&#34;; then  
    ngx_module_incs=$ngx_addon_dir  
    ngx_module_deps=$RTMP_DEPS  
    if [ $ngx_module_link = DYNAMIC ] ; then  
        ngx_module_name=&#34;$RTMP_CORE_MODULES $RTMP_HTTP_MODULES&#34;  
        ngx_module_srcs=&#34;$RTMP_CORE_SRCS $RTMP_HTTP_SRCS&#34;  
        . auto/module  
    elif [ $ngx_module_link = ADDON ] ; then  
        ngx_module_type=CORE  
        ngx_module_name=$RTMP_CORE_MODULES  
        ngx_module_srcs=$RTMP_CORE_SRCS  
        . auto/module  
        ngx_module_type=HTTP  
        ngx_module_name=$RTMP_HTTP_MODULES  
        ngx_module_srcs=$RTMP_HTTP_SRCS  
        . auto/module  
    fi  
  
#nginx version &lt; 1.9.11  
else  
    CORE_MODULES=&#34;$CORE_MODULES  
                  $RTMP_CORE_MODULES&#34;  
    HTTP_MODULES=&#34;$HTTP_MODULES  
                  $RTMP_HTTP_MODULES&#34;  
    NGX_ADDON_DEPS=&#34;$NGX_ADDON_DEPS \  
                    $RTMP_DEPS&#34;  
    NGX_ADDON_SRCS=&#34;$NGX_ADDON_SRCS  
                    $RTMP_CORE_SRCS  
                    $RTMP_HTTP_SRCS&#34;  
    CFLAGS=&#34;$CFLAGS -I$ngx_addon_dir&#34;  
fi  
  
USE_OPENSSL=YES  </pre></div>
<p>然后调整所有 c 源文件里使用 ngx_modules 的地方，可以添加类似如下的代码片段:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">#if defined(nginx_version) &amp;&amp; nginx_version &gt;= 1009011  
    modules = cf-&gt;cycle-&gt;modules;  
#else  
    modules = ngx_modules;  
#endif  </pre></div>
<p>这样就可以达到我们的目的了。</p>

<p>具体关于编译脚本的调整，我们参考一下官方的几个文档即可：</p>

<ul>
<li><a href="https://www.nginx.com/resources/wiki/extending/converting/">Converting Static Modules to Dynamic Modules</a><br /></li>
<li><a href="https://www.nginx.com/resources/wiki/extending/new_config/">New Config Shell File</a><br /></li>
<li><a href="https://www.nginx.com/resources/wiki/extending/old_config/">Old Config Shell File</a><br />
<br /></li>
</ul>

<p>注意，上面的文档中，关于 rtmp 模块的调整，是有问题的，一方面如果那些使用了 ngx_modules 全局变量的 c 文件不相应修改的话，运行时会有段错误；另一方面，示例里对 config 文件的调整，只能保证对于 Nginx-1.9.11 及其以后的版本能同时支持编译为动态模块和静态模块，却对 Nginx-1.9.11 之前的版本的支持有问题。</p>
		</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = '';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div><a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


</body>
</html>
