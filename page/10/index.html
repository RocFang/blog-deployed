<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>纯真年代</title>
  
<link rel="alternate" hreflang="en" href="https://pureage.info/en/" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="strider" />
  <meta name="description" content="纯真年代" />
  <meta name="keywords" content="程序员, 文学, 生活" />






<meta name="generator" content="Hugo 0.59.1" />


<link rel="canonical" href="https://pureage.info/" />
<link href="/index.xml" rel="alternate" type="application/rss+xml" title="纯真年代" />




<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="纯真年代" />
<meta property="og:description" content="纯真年代" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://pureage.info/" />

<meta property="og:updated_time" content="2019-11-15T16:46:29+08:00" />
<meta itemprop="name" content="纯真年代">
<meta itemprop="description" content="纯真年代">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="纯真年代"/>
<meta name="twitter:description" content="纯真年代"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">纯真年代</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/tools/">工具</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/about/">关于</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      纯真年代
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item active">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/tools/">工具</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/about/">关于</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          
<section id="posts" class="posts">
  
  
    
  
  
  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2015/12/20/meet-an-old-friend.html">小聚，小感</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2015-12-20" class="post-time">
        2015-12-20
      </time>
      
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <p>大学室友涛从南京来深圳出差，今天特意抽空到我家来小聚了一下。从大学毕业，到现在已经有6年多没见了，大学四年同处一室的感情还是挺深的，尽管这么久没见面了，仍没有生疏感。朋友之间相处没有生疏感的表现就是，面对彼此都没有交流上的压力，我不用刻意找话题跟你聊天，你也不用刻意逢迎我的喜好，吃饭时我不用担心是否你酒没喝到，你也不用按照我的节奏来喝酒。有一茬没一茬的聊天，一杯半盏的喝酒，自由惬意。</p>

<p>说起来大学毕业都六年了。六年后再见面，我们都已经成家，他还有了一个刚满一岁的女儿。似水流年，流年似水，平日里丝毫不觉得，只有在带有旧日痕迹的事物放到面前时，感慨才会如此强烈。但不可避免的事实是，我们都是生活中的人了。不可能彻夜长谈，不可能一直回味过去。离别才是常态，小聚只是片段。所谓生活中的人，就是对生活本身习以为常，面对相聚别离，不会有太多悲喜。</p>

<p>曾经的我是一个很怀旧的人。记得在六七岁的时候，经常会在睡觉跟自己对话:明天这个时候，此刻就已经成为过去，所以我现在要刻意的想一些东西，明天这个时候好回忆。原来自己小时候，还挺文艺的。</p>

<p>从个人管理的角度上说，过于怀旧当然是不好的。所以，现在我已经刻意做出了很多改变。这种改变花了很长时间，很不容易。难度不亚于吸烟者戒掉烟瘾。</p>

<p>但我并不觉得，一个坦然面对现在的人，比一个沉迷过去的人更值得被人尊崇。面对时间、宇宙，一切都太渺小。即使一个人活着的每一天都能活在当下，到死的那一刻，我相信过去的影像还是会在脑海中跳跃闪回。所以，如果让现在的我去劝说一个正处于“为赋新词强说愁”的年龄的少年，我还真不知道该如何组织语言，让他听信于我。</p>

<p>我想我只能说出“尊敬时间就是尊敬自己，尊敬自己就是尊敬时间，所以不要让时间白白流失掉”这类无聊的话吧。</p>
    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2015/12/18/lets-talk-about-running-again.html">跑步的意义</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2015-12-18" class="post-time">
        2015-12-18
      </time>
      
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <p>去年报名了清远马拉松半程赛之后，我写了一篇 Blog 记录了一下: <a href="http://pureage.info/2014/12/30/qingyuan-marathon.html">报名了清远马拉松</a>。时间差不多过去了整整一年，今天我再次报名参加清远马拉松。</p>

<p>下面就说说，在即将过去的 2015 年里，关于跑步这件事儿上的一些片段和思考。</p>

<p>2015 年，跑了两次马拉松，拿了两个纪念牌，说明我百马人生的目标已经完成了百分之二。其实这个目标是怎么来的我都不记得了，但似乎有了这个说法之后，跑步这件事情顿时被赋予了一层特别的意义一样。</p>

<p>跑步的意义对我到底是什么，我思考了一段时间。</p>

<p>跑步对我意义重大。这次正儿八经的开始跑步，其实是因为当时面临着一场巨大的危机，家庭、工作异常不顺，尤其是家庭，连续一年多，经常都处在崩溃的边缘。直到有一天我受不了了，决定反击。反击的时候总得有个象征性的东西吧，比如影视作品里飘扬的旗帜、燃爆的音乐，于是我选择了跑步。这种个人情况和内心的活动，外人是毫无察觉的，同事们看我开始每天下班跑步，还挺羡慕的。于是，就这么熬到了现在。从这个角度说，跑步拯救了我。</p>

<p>但是如果仅仅停留在这个层面的思考，然后就说，跑步吧，跑步能改变你的人生，这未免也太肤浅了。真实的情况不是那样的。</p>

<p>跑步就是跑步，仅此而已。它不能于任何困境中拯救任何人。能拯救一个人的，只能是他自己。在跑步这件事上，是我首先意识到，我该主动改变一下工作、生活中的状态，跑步只不过是一种号角性质的东西，起到助燃和提醒的作用。助燃作用不用多说，提醒作用说的是，只要这个习惯还在继续，那么个人的状态和态度都应该继续。</p>

<p>客观的说，跑步本身的作用有两个。一是促进分泌多巴胺，让人有一种愉悦的心情。二是能真实的增强体质，身体好了，所谓的精气神就上来了。</p>

<p>把跑步换成任何一种对健康或心理有积极作用的习惯，都能起到这个作用。比如瑜伽、钓鱼、学习一门乐器等等。把多余的精力消耗掉，让心情平静下来，就不会有那么多的时间和精力耗在空虚的消极情绪中。</p>

<p>所以，最厉害的人是那些不需要借助外部运动，就能获得内心平静和力量的人，各种先贤圣哲多是这样的人。</p>

<p>而我们普通人很难仅凭内心自省的力量，就能让自己活得平静。我还是继续跑下去吧。</p>
    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2015/12/16/still-using-typecho.html">继续留在Typecho</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2015-12-16" class="post-time">
        2015-12-16
      </time>
      
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <p>最近手心手背总时不时发痒，又开始想折腾博客玩了。</p>

<p>这个小小的个人博客，从 2011 年开始，几乎把主流的 Blog 系统折腾了个遍，从最初的 Wordpress,到 Typecho, Emlog, Textpattern 等等。其中，Typecho 被来回折腾了几次，因为 Typecho 自身也经历了两个大的阶段：从几年没有维护，到开始重构并默认支持 Markdown 编辑器。</p>

<p>每个阶段维护博客的心态也不一样。刚开始的时候，总到处想和人交换链接，把界面搞得好看点，各种插件都试一试。这个阶段确实还真认识了一些一起写博客的同学，大家经常互访互评，搞得还挺热闹。但是必须要知道的是，即使在 2011 年之前，个人博客也早已经开始没落了，这是大势所趋，曾经的那些博客，到现在也已经绝大多数打不开，还挺让人唏嘘的。</p>

<p>后来就不怎么想折腾了，也不再去管写的东西到底有没有人看，因为知道这其实并没有什么意义。前面提到的几次折腾 Typecho 的过程，其实就体现了这种心态的变化。Typecho 之前的版本是很简洁甚至简陋的，默认连编辑器都没有，恰好是这个特点，一方面决定了它在某个时刻打动了我，另一方面又决定了不会在它上面停留很久。直到 2013 年，Typecho 重新开发，增加了一些特性，其中最重要的一个特性是原生支持 Markdown 编辑器，支持实时预览，恰好在那个时刻，我觉得这个特性就是我最需要的，所以在 2013 年就又将博客切到 Typecho，一直到现在。</p>

<p>如果说这个从主动愿意折腾，到后来不想折腾的变化，算是一个成长的轨迹的话，为什么现在又突然想再重新折腾呢？似乎是一种矛盾，但其实是统一的，就是越来越想真的将精力放在文章本身了。看看这些备选项你就懂了:</p>

<ul>
<li>Jekyll<br /></li>
<li>Octopress<br /></li>
<li>Ghost<br /></li>
<li>Farbox<br /></li>
<li>Hexo<br />
<br /></li>
</ul>

<p>上面列出的每一项我都试用过，最终锁定在 Hexo 上，都挽起袖子开始准备写转换脚本了。<strong>临在最后关头，又打住了</strong>。</p>

<p>如果是早两年，此时这博客肯定就已经是迁移完了，评论什么的多半也再次都搞丢了。不过现在既然网站的底部还写着“由 Typecho 强力驱动”，则说明我已经打定主意不迁了。</p>

<p>因为我只反问了自己一句：现在 Typecho 有让你用着不爽的地方吗？ 即使是 Typecho 的开发者 joyqi 都开始拥抱变化，捣腾出一个 PHP 版本的静态博客生成系统 Logecho 了， Typecho 确实并没有让我用起来有不好的感觉。既然没有，为什么要换呢？</p>
    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2015/12/10/nginx-slice-module.html">尝鲜：Nginx-1.9.8推出的切片模块</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2015-12-10" class="post-time">
        2015-12-10
      </time>
      
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <p>熟悉 CDN 行业主流技术的朋友应该都比较清楚，虽然 Nginx 近几年发展的如日中天，但是基本上没有直接使用它自带的 proxy_cache 模块来做缓存的，原因有很多，例如下面几个：</p>

<ul>
<li>不支持多盘</li>
<li>不支持裸设备<br /></li>
<li>大文件不会切片<br /></li>
<li>大文件的 Range 请求表现不尽如人意<br /></li>
<li>Nginx 自身不支持合并回源
<br />
<br /></li>
</ul>

<p>当然，上面列出来的并不全， 所以，在现在主流的 CDN 技术栈里面， Nginx 起到的多是一个粘合剂的作用，例如调度器、负载均衡器、业务逻辑（防盗链等），需要与 Squid、ATS 等主流 Cache Server 配合使用，即使不使用这些技术，也会使用其它办法，例如直接使用文件系统和数据库去管理文件，而不会直接使用 proxy_cache 模块。</p>

<p>Nginx-1.9.8 中新增加的一个模块ngx_http_slice_module解决了一部分问题。本文就来尝尝鲜，看看这个切片模块。</p>

<p>注意：截至到发文时，Nginx 马上发布了 Nginx-1.9.9，用来解决 Nginx-1.9.8中的一个 Bug，所以，在实际使用中，如果需要使用本新增特性，请直接使用 Nginx-1.9.9。</p>

<p>首先，我们看看几个不同版本的 Nginx 的 proxy_cache 对 Range 的处理情况。</p>

<h3 id="nginx-0-8-15">Nginx-0.8.15</h3>

<p>在 Nginx-0.8.15 中，使用如下配置文件做测试:</p>

<pre><code>http {  
    include       mime.types;  
    default_type  application/octet-stream;  
    sendfile        on;  
    keepalive_timeout  65;  
  
    proxy_cache_path /tmp/nginx/cache levels=1:2 keys_zone=cache:100m;  
    server {    
        listen       8087;  
        server_name  localhost;  
        location / {  
            proxy_cache cache;  
            proxy_cache_valid 200 206 1h;  
           # proxy_set_header Range $http_range;  
            proxy_pass http://127.0.0.1:8080;  
  
        }  
        error_page   500 502 503 504  /50x.html;  
        location = /50x.html {  
            root   html;  
        }  
  
    }  
}  
</code></pre>

<p>重点说明以下两种情况：<br />
* 第一次 Range 请求（没有本地缓存），Nginx 会去后端将整个文件拉取下来（后端响应码是200）后，并且返回给客户端的是整个文件，响应状态码是200，而非206. 后续的 Range 请求则都用缓存下来的本地文件提供服务，且响应状态码都是对应的206了。<br />
* 如果在上面的配置文件中，加上 proxy_set_header Range $http_range;再进行测试(测试前先清空 Nginx 本地缓存)。则第一次 Range 请求（没有本地缓存），Nginx 会去后端用 Range 请求文件，而不会把整个文件拉下来，响应给客户端的也是206.但问题在于，由于没有把 Range 请求加入到 cache key 中，会导致后续所有的请求，不管 Range 如何，只要 url 不变，都会直接用cache 的内容来返回给客户端，这肯定是不符合要求的。</p>

<h3 id="nginx-1-9-7">Nginx-1.9.7</h3>

<p>在 Nginx-1.9.7 中，同样进行上面两种情况的测试，第二种情况的结果其实是没多少意义，而且肯定也和 Nginx-0.8.15 一样，所以这里只关注第一种测试情况。</p>

<p>第一次 Range 请求（没有本地缓存），Nginx 会去后端将整个文件拉取下来（后端响应码是200），但返回给客户端的是正确的 Range 响应，即206.后续的 Range 请求，则都用缓存下来的本地文件提供服务，且都是正常的206响应。</p>

<p>可见，与之前的版本相比，还是有改进的，但并没有解决最实质的问题。</p>

<p>我们可以看看 Nginx 官方对于 Cache 在 Range 请求时行为的说明:</p>

<blockquote>
<p>How Does NGINX Handle Byte Range Requests?</p>

<p>If the file is up-to-date in the cache, then NGINX honors a byte range request and serves only the specified bytes of the item to the client. If the file is not cached, or if it’s stale, NGINX downloads the entire file from the origin server. If the request is for a single byte range, NGINX sends that range to the client as soon as it is encountered in the download stream. If the request specifies multiple byte ranges within the same file, NGINX delivers the entire file to the client when the download completes.</p>

<p>Once the download completes, NGINX moves the entire resource into the cache so that all future byte-range requests, whether for a single range or multiple ranges, are satisfied immediately from the cache.</p>
</blockquote>

<h3 id="nginx-1-9-8">Nginx-1.9.8</h3>

<p>我们继续看看Nginx-1.9.8, 当然，在编译时要加上参数&ndash;with-http_slice_module，并作类似下面的配置:</p>

<pre><code>http {  
    include       mime.types;  
    default_type  application/octet-stream;  
    sendfile        on;  
    keepalive_timeout  65;  
  
    proxy_cache_path /tmp/nginx/cache levels=1:2 keys_zone=cache:100m;  
    server {  
        listen       8087;  
        server_name  localhost;  
        location / {  
            slice 1m;  
            proxy_cache cache;  
            proxy_cache_key $uri$is_args$args$slice_range;  
            proxy_set_header Range $slice_range;  
            proxy_cache_valid 200 206 1h;  
            #proxy_set_header Range $http_range;  
            proxy_pass http://127.0.0.1:8080;  
  
        }  
        error_page   500 502 503 504  /50x.html;  
        location = /50x.html {  
            root   html;  
        }  
  
    }  
}  
</code></pre>

<p>不测不知道，一侧吓一跳，这俨然是一个杀手级的特性。</p>

<p>首先，如果不带 Range 请求，后端大文件在本地 cache 时，会按照配置的 slice 大小进行切片存储。</p>

<p>其次，如果带 Range 请求，则 Nginx 会用合适的 Range 大小（以 slice 为边界）去后端请求，这个大小跟客户端请求的 Range 可能不一样，并将以 slice 为大小的切片存储到本地，并以正确的206响应客户端。</p>

<p>注意上面所说的，Nginx 到后端的 Range 并不一定等于客户端请求的 Range，因为无论你请求的Range 如何，Nginx 到后端总是以 slice 大小为边界，将客户端请求分割成若干个子请求到后端，假设配置的 slice 大小为1M,即1024字节，那么如果客户端请求 Range 为0-1023范围以内任何数字，均会落到第一个切片上，如果请求的 Range 横跨了几个 slice 大小，则nginx会向后端发起多个子请求，将这几个 slice 缓存下来。而对客户端，均以客户端请求的 Range 为准。如果一个请求中，有一部分文件之前没有缓存下来，则 Nginx 只会去向后端请求缺失的那些切片。</p>

<p>由于这个模块是建立在子请求的基础上，会有这么一个潜在问题：当文件很大或者 slice 很小的时候，会按照 slice 大小分成很多个子请求，而这些个子请求并不会马上释放自己的资源，可能会导致文件描述符耗尽等情况。</p>

<h3 id="小结">小结</h3>

<p>总结一下，需要注意的点：</p>

<ul>
<li>该模块用在 proxy_cache 大文件的场景，将大文件切片缓存<br /></li>
<li>编译时对 configure 加上 &ndash;with-http_slice_module 参数<br /></li>
<li>$slice_range 一定要加到 proxy_cache_key 中，并使用 proxy_set_header 将其作为 Range 头传递给后端<br /></li>
<li>要根据文件大小合理设置 slice 大小<br />
<br /></li>
</ul>

<p>具体特性的说明，可以参考 Roman Arutyunyan 提出这个 patch 时的邮件来往：<br />
<a href="https://forum.nginx.org/read.php?29,261929,261929#msg-261929">https://forum.nginx.org/read.php?29,261929,261929#msg-261929</a></p>

<p>顺带提一下，Roman Arutyunyan 也是个大牛，做流媒体领域的同学们肯定很多都听说过：<a href="https://github.com/arut/nginx-rtmp-module">nginx-rtmp</a> 模块的作者。</p>

<h3 id="参考资料">参考资料</h3>

<ol>
<li>Nginx 官方的 Cache 指南<br />
<a href="https://www.nginx.com/blog/nginx-caching-guide/">https://www.nginx.com/blog/nginx-caching-guide/</a><br /></li>
<li>Nginx各版本changelog<br />
<a href="http://nginx.org/en/CHANGES">http://nginx.org/en/CHANGES</a><br /></li>
<li>Nginx proxy 模块 wiki<br />
<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html">http://nginx.org/en/docs/http/ngx_http_proxy_module.html</a><br /></li>
<li>http_slice_module 的历次提交记录<br />
<a href="http://hg.nginx.org/nginx/rev/29f35e60840b">http://hg.nginx.org/nginx/rev/29f35e60840b</a><br />
<a href="http://hg.nginx.org/nginx/rev/bc9ea464e354">http://hg.nginx.org/nginx/rev/bc9ea464e354</a><br />
<a href="http://hg.nginx.org/nginx/rev/4f0f4f02c98f">http://hg.nginx.org/nginx/rev/4f0f4f02c98f</a><br /></li>
<li>http_slice_module 提交前的邮件来往<br />
<a href="https://forum.nginx.org/read.php?29,261929">https://forum.nginx.org/read.php?29,261929</a><br /></li>
<li>Nginx 之前版本关于 Range cache 的邮件来往<br />
<a href="https://forum.nginx.org/read.php?2,8958,8958">https://forum.nginx.org/read.php?2,8958,8958</a><br /></li>
<li>切片模块的 wiki<br />
<a href="http://nginx.org/en/docs/http/ngx_http_slice_module.html">http://nginx.org/en/docs/http/ngx_http_slice_module.html</a><br />
<br />
<br /></li>
</ol>
    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2015/12/10/bugfix-of-nginx.html">Nginx紧急发布1.9.9修复bug</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2015-12-10" class="post-time">
        2015-12-10
      </time>
      
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <p>有时候，仔细追踪一个项目的各次提交也是蛮有趣的，特别是各种 Bugfix，会发现，原来牛人也会有各种低级错误。</p>

<p>例如，Nginx 刚在12月8号发布了nginx-1.9.8, 马上就在nginx-1.9.9,这种密集的发布，一看就是 Bug 修复了。我们看看到底修复了什么 Bug。</p>

<p>首先，看看changelog:</p>

<blockquote>
<p>Changes with nginx 1.9.9                                         09 Dec 2015</p>

<p>*) Bugfix: proxying to unix domain sockets did not work when using<br />
       variables; the bug had appeared in 1.9.8.</p>
</blockquote>

<p>再来看看是如何修复的，变更前的代码片段:</p>

<pre><code>static void  
ngx_http_upstream_init_request(ngx_http_request_t *r)  
{  
    ....(略）....  
    if (u-&gt;resolved-&gt;port == 0) {  
        ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0,  
                      &quot;no port in upstream \&quot;%V\&quot;&quot;, host);  
        ngx_http_upstream_finalize_request(r, u,  
                                       NGX_HTTP_INTERNAL_SERVER_ERROR);  
        return;  
    }  
    ....(略)....  
}  
</code></pre>

<p>变更后的代码片段：</p>

<pre><code>static void  
ngx_http_upstream_init_request(ngx_http_request_t *r)  
{  
    ....(略)....  
            if (u-&gt;resolved-&gt;port == 0  
                &amp;&amp; u-&gt;resolved-&gt;sockaddr-&gt;sa_family != AF_UNIX)  
            {  
                ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;log, 0,  
                              &quot;no port in upstream \&quot;%V\&quot;&quot;, host);  
                ngx_http_upstream_finalize_request(r, u,  
                                               NGX_HTTP_INTERNAL_SERVER_ERROR);  
                return;  
            }  
    ....(略)....  
}  
</code></pre>

<p>作为旁观者和事后诸葛亮，可以很明显看出之前的问题所在：在 upstream 中，Unix 本地域套接字不能用了。</p>

<p>这次版本更新，除了修正这个 Bug 外，没有做其他任何事情，所以，如果你已经尝鲜在用 1.9.8 了，赶紧直接升级到1.9.9 吧。</p>
    </div>
    
  </div>
</article>

  
</section>






  
  
  

  
  

  
  

  
  

  
  

    <nav class="pagination">
      <ul>

      
      
      <li><a href="/">««</a></li>
      

      
      
      <li><a href="/page/9/">«</a></li>
      

      
      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/4/">
              4
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/5/">
              5
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/6/">
              6
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/7/">
              7
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/8/">
              8
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/9/">
              9
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="active">
            <a href="/page/10/">
              10
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/11/">
              11
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/12/">
              12
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/13/">
              13
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/14/">
              14
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/15/">
              15
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/16/">
              16
            </a>
          </li>
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

      
      
      <li><a href="/page/11/">»</a></li>
      

      
      
      <li><a href="/page/37/">»»</a></li>
      

      </ul>
    </nav>
  





        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  


<a href="https://pureage.info/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2011 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        strider
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
