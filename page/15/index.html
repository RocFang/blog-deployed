<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>纯真年代</title>
  
<link rel="alternate" hreflang="en" href="https://pureage.info/en/" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="strider" />
  <meta name="description" content="纯真年代" />
  <meta name="keywords" content="程序员, 文学, 生活" />






<meta name="generator" content="Hugo 0.59.1" />


<link rel="canonical" href="https://pureage.info/" />
<link href="/index.xml" rel="alternate" type="application/rss+xml" title="纯真年代" />




<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="纯真年代" />
<meta property="og:description" content="纯真年代" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://pureage.info/" />

<meta property="og:updated_time" content="2019-11-15T16:46:29+08:00" />
<meta itemprop="name" content="纯真年代">
<meta itemprop="description" content="纯真年代">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="纯真年代"/>
<meta name="twitter:description" content="纯真年代"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">纯真年代</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/">首页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/tools/">工具</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/about/">关于</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      纯真年代
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item active">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/">首页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/tools/">工具</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://pureage.info/about/">关于</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          
<section id="posts" class="posts">
  
  
    
  
  
  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2014/08/25/hiding-302-using-proxy-pass.html">用proxy_intercept_errors和recursive_error_pages代理多次302</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2014-08-25" class="post-time">
        2014-08-25
      </time>
      
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <p>302是HTTP协议中的一个经常被使用状态码，是多种重定向方式的一种，其语义经常被解释为“Moved Temporarily”。这里顺带提一下，现实中用到的302多为误用（与303，307混用），在HTTP/1.1中，它的语义为“Found”.</p>

<p>302有时候很明显，有时候又比较隐蔽。最简单的情况，是当我们在浏览器中输入一个网址A，然后浏览器地址栏会自动跳到B，进而打开一个网页，这种情况就很可能是302。</p>

<p>比较隐蔽的情况经常发生在嵌入到网页的播放器中。例如，当你打开一个优酷视频播放页面时，抓包观察一下就会经常发现302的影子。但由于这些url并不是直接在浏览器中打开的，所以在浏览器的地址栏看不到变化，当然，如果将这些具体的url特意挑出来复制到浏览器地址栏里，还是可以观察到的。</p>

<p>上一段提到了优酷。其实现在多数在线视频网站都会用到302，原因很简单，视频网站流量一般较大，都会用到CDN,区别只在于是用自建CDN还是商业CDN。而由于302的重定向语义（再重复一遍，302的语义广泛的被误用，在使用302的时候，我们很可能应该使用303或307，但后面都不再纠结这一点），可以与CDN中的调度很好的结合起来。</p>

<p>我们来看一个例子，打开一个网易视频播放页面，抓一下包，找到302状态的那个url。例如：</p>

<pre><code>http://flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4  
</code></pre>

<p>我们把它复制到浏览器地址栏中，会发现地址栏迅速的变为了另外一个url，这个Url是不定的，有可能为：</p>

<pre><code>http://14.18.140.83/f6c00af500000000-1408987545-236096587/data6/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4  
</code></pre>

<p>用curl工具会更清楚的看到整个过程：</p>

<pre><code>curl -I &quot;http://flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4&quot; -L  
HTTP/1.1 302 Moved Temporarily 
Server: nginx 
Date: Mon, 25 Aug 2014 14:49:43 GMT 
Content-Type: text/html 
Content-Length: 154 
Connection: keep-alive 
NG: CCN-SW-1-5L2 
X-Mod-Name: GSLB/3.1.0 
Location: http://119.134.254.9/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4 
  
HTTP/1.1 302 Moved Temporarily 
Server: nginx 
Date: Mon, 25 Aug 2014 14:49:41 GMT 
Content-Type: text/html 
Content-Length: 154 
Connection: keep-alive 
X-Mod-Name: Mvod-Server/4.3.3 
Location: http://119.134.254.7/cc89fdac00000000-1408983581-2095617481/data4/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4 
NG: CHN-SW-1-3Y1 
  
HTTP/1.1 200 OK 
Server: nginx 
Date: Mon, 25 Aug 2014 14:49:41 GMT 
Content-Type: video/mp4 
Content-Length: 3706468 
Last-Modified: Mon, 25 Aug 2014 00:23:50 GMT 
Connection: keep-alive 
Cache-Control: no-cache 
ETag: &quot;53fa8216-388e64&quot; 
NG: CHN-SW-1-3g6 
X-Mod-Name: Mvod-Server/4.3.3 
Accept-Ranges: bytes 
</code></pre>

<p>可以看到，这中间经历了两次302。</p>

<p>先暂时将这个例子放在一边，再来说说另一个重要的术语：proxy.我们通常会戏称，某些领导是302类型的，某些领导是proxy类型的。302类型的领导，一件事情经过他的手，会迅速的转给他人，而proxy类型的领导则会参与到事情中来，甚至把事情全部做完。</p>

<p>回到上面的例子，如果访问一个url中途会有多个302，那如果需要用Nginx设计一个proxy，来隐藏掉中间所有的这些302，该怎么做呢？</p>

<h3 id="1-原始proxy">1.原始Proxy</h3>

<p>我们知道，Nginx本身就是一个优秀的代理服务器。因此，首先我们来架设一个Nginx正向代理，服务器IP为192.168.109.128（我的一个测试虚拟机）。</p>

<p>初始配置简化如下：</p>

<pre><code>server {  
        listen 80;  
        location / {  
                rewrite_by_lua '  
                        ngx.exec(&quot;/proxy-to&quot; .. ngx.var.request_uri)  
                ';  
        }  
  
        location ~ /proxy-to/([^/]+)(.*) {  
                proxy_pass http://$1$2$is_args$query_string;  
  
        }  
}  
</code></pre>

<p>实现的功能是，当使用</p>

<pre><code>http://192.168.109.128/xxxxxx  
</code></pre>

<p>访问该代理时，会proxy到xxxxxx所代表的真实服务器。</p>

<p>测试结果如下：</p>

<pre><code>curl -I &quot;http://192.168.109.128/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4&quot; -L  
HTTP/1.1 302 Moved Temporarily 
Server: nginx/1.4.6 
Date: Mon, 25 Aug 2014 14:50:54 GMT 
Content-Type: text/html 
Content-Length: 154 
Connection: keep-alive 
NG: CCN-SW-1-5L2 
X-Mod-Name: GSLB/3.1.0 
Location: http://183.61.140.24/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4 
  
HTTP/1.1 302 Moved Temporarily 
Server: nginx 
Date: Mon, 25 Aug 2014 14:50:55 GMT 
Content-Type: text/html 
Content-Length: 154 
Connection: keep-alive 
X-Mod-Name: Mvod-Server/4.3.3 
Location: http://183.61.140.20/540966e500000000-1408983655-236096587/data1/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4 
NG: CHN-ZJ-4-3M4 
  
HTTP/1.1 200 OK 
Server: nginx 
Date: Mon, 25 Aug 2014 14:50:55 GMT 
Content-Type: video/mp4 
Content-Length: 3706468 
Last-Modified: Mon, 25 Aug 2014 00:31:03 GMT 
Connection: keep-alive 
Cache-Control: no-cache 
ETag: &quot;53fa83c7-388e64&quot; 
NG: CHN-ZJ-4-3M4 
X-Mod-Name: Mvod-Server/4.3.3 
Accept-Ranges: bytes  
</code></pre>

<p>可见，虽然使用proxy，但过程与原始访问没有什么区别。访问过程为，当访问</p>

<pre><code>http://192.168.109.128/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4  
</code></pre>

<p>时，Nginx会将该请求proxy到</p>

<pre><code>http://flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4  
</code></pre>

<p>而后者马上就会返回一个302，所以Nginx作为proxy，将该302传回到客户端，客户端重新发起请求，进而重复之前的多次302.这里说明一个问题，一旦Nginx的proxy的后端返回302后，客户端即与Nginx这个proxy脱离关系了，Nginx无法起到完整的代理的作用。</p>

<h3 id="2-第1次修改">2. 第1次修改</h3>

<p>将配置文件修改为：</p>

<pre><code>server {  
        listen 80;  
        location / {  
                rewrite_by_lua '  
                        ngx.exec(&quot;/proxy-to&quot; .. ngx.var.request_uri)  
                ';  
        }  
  
        location ~ /proxy-to/([^/]+)(.*) {  
                proxy_pass http://$1$2$is_args$query_string;  
                error_page 302 = @error_page_302;  
  
        }  
        location @error_page_302 {  
                rewrite_by_lua '  
                        local _, _, upstream_http_location = string.find(ngx.var.upstream_http_location, &quot;^http:/(.*)$&quot;)  
                        ngx.header[&quot;zzzz&quot;] = &quot;/proxy-to&quot; .. upstream_http_location  
                        ngx.exec(&quot;/proxy-to&quot; .. upstream_http_location);  
                ';  
  
        }  
}  
</code></pre>

<p>与上面的区别在于，使用了一个error_page，目的是当发现proxy的后端返回302时，则用这个302的目的location继续proxy，而不是直接返回给客户端。并且这个逻辑里面包含着递归的意思，一路跟踪302，直到最终返回200的那个地址。测试结果如下：</p>

<pre><code>curl -I &quot;http://192.168.109.128/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4&quot; -L  
HTTP/1.1 302 Moved Temporarily 
Server: nginx/1.4.6 
Date: Mon, 25 Aug 2014 15:01:17 GMT 
Content-Type: text/html 
Content-Length: 154 
Connection: keep-alive 
NG: CCN-SW-1-5L2 
X-Mod-Name: GSLB/3.1.0 
Location: http://183.61.140.24/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4 
  
HTTP/1.1 302 Moved Temporarily 
Server: nginx 
Date: Mon, 25 Aug 2014 15:01:17 GMT 
Content-Type: text/html 
Content-Length: 154 
Connection: keep-alive 
X-Mod-Name: Mvod-Server/4.3.3 
Location: http://183.61.140.20/a90a952900000000-1408984277-236096587/data1/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4 
NG: CHN-ZJ-4-3M4 
  
HTTP/1.1 200 OK 
Server: nginx 
Date: Mon, 25 Aug 2014 15:01:17 GMT 
Content-Type: video/mp4 
Content-Length: 3706468 
Last-Modified: Mon, 25 Aug 2014 00:31:03 GMT 
Connection: keep-alive 
Cache-Control: no-cache 
ETag: &quot;53fa83c7-388e64&quot; 
NG: CHN-ZJ-4-3M4 
X-Mod-Name: Mvod-Server/4.3.3 
Accept-Ranges: bytes  
</code></pre>

<p>可见，本次修改仍然没有成功！<br />
为什么呢？分析一下，我们在@error_page_302这个location里已经加了一个头部打印语句，可是在测试中，该头部并没有打出来，可见流程并没有进入到@error_page_302这个location。</p>

<p>原因在于</p>

<pre><code>error_page 302 = @error_page_302;  
</code></pre>

<p>error_page默认是本次处理的返回码。作为proxy，本次处理，只要转发上游服务器的响应成功，应该状态码都是200.即，我们真正需要检查的，是proxy的后端服务器返回的状态码，而不是proxy本身返回的状态码。查一下Nginx的wiki,proxy_intercept_errors指令正是干这个的:</p>

<pre><code>Syntax:	proxy_intercept_errors on | off;  
Default:	  
proxy_intercept_errors off;  
Context:	http, server, location  
Determines whether proxied responses with codes greater than or equal to 300 should be passed to a client or be redirected to nginx for processing with the error_page directive.  
</code></pre>

<h3 id="3-第二次修改">3. 第二次修改</h3>

<pre><code>server {  
        listen 80;  
        proxy_intercept_errors on;  
        location / {  
                rewrite_by_lua '  
                        ngx.exec(&quot;/proxy-to&quot; .. ngx.var.request_uri)  
                ';  
        }  
        location ~ /proxy-to/([^/]+)(.*) {  
                proxy_pass http://$1$2$is_args$query_string;  
                error_page 302 = @error_page_302;  
  
        }  
        location @error_page_302 {  
                rewrite_by_lua '  
                        local _, _, upstream_http_location = string.find(ngx.var.upstream_http_location, &quot;^http:/(.*)$&quot;)  
                        ngx.header[&quot;zzzz&quot;] = &quot;/proxy-to&quot; .. upstream_http_location  
                        ngx.exec(&quot;/proxy-to&quot; .. upstream_http_location);  
                ';  
        }  
}  
</code></pre>

<p>与上一次修改相比，区别仅仅在于增加了一个proxy_intercept_errors指令。测试结果如下：</p>

<pre><code>curl -I &quot;http://192.168.109.128/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4&quot; -L 
HTTP/1.1 302 Moved Temporarily  
Server: nginx/1.4.6  
Date: Mon, 25 Aug 2014 15:05:54 GMT  
Content-Type: text/html  
Content-Length: 160  
Connection: keep-alive  
zzzz: /proxy-to/183.61.140.24/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4 
</code></pre>

<p>这次更神奇了，直接返回一个302状态完事，也不继续跳转了。<br />
问题出在，虽然第一次302，请求成功的进入到@error_page_302，但后续的error_page指令却没起作用。也就是说，error_page只检查了第一次后端返回的状态码，而没有继续检查后续的后端状态码。</p>

<p>查一下资料，这个时候，另一个指令 recursive_error_pages就派上用场了。</p>

<h3 id="4-第3次修改">4. 第3次修改</h3>

<pre><code>server {  
        listen 80;  
        proxy_intercept_errors on;  
        recursive_error_pages on;  
        location / {  
                rewrite_by_lua '  
                        ngx.exec(&quot;/proxy-to&quot; .. ngx.var.request_uri)  
                ';  
        }  
        location ~ /proxy-to/([^/]+)(.*) {  
                proxy_pass http://$1$2$is_args$query_string;  
                error_page 302 = @error_page_302;  
  
        }  
        location @error_page_302 {  
                rewrite_by_lua '  
                        local _, _, upstream_http_location = string.find(ngx.var.upstream_http_location, &quot;^http:/(.*)$&quot;)  
                        ngx.header[&quot;zzzz&quot;] = &quot;/proxy-to&quot; .. upstream_http_location  
                        ngx.exec(&quot;/proxy-to&quot; .. upstream_http_location);  
                ';  
        }  
}  
</code></pre>

<p>与上一次相比，仅仅增加了recursive_error_pages on这条指令。测试结果如下：</p>

<pre><code>curl -I &quot;http://192.168.109.128/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4&quot; -L 
HTTP/1.1 200 OK 
Server: nginx/1.4.6 
Date: Mon, 25 Aug 2014 15:09:04 GMT 
Content-Type: video/mp4 
Content-Length: 3706468 
Connection: keep-alive 
zzzz: /proxy-to/14.18.140.83/f48bad0100000000-1408984745-236096587/data6/flv.bn.netease.com/tvmrepo/2014/8/5/P/EA3I1J05P/SD/EA3I1J05P-mobile.mp4 
Last-Modified: Mon, 25 Aug 2014 00:21:07 GMT 
Cache-Control: no-cache 
ETag: &quot;53fa8173-388e64&quot; 
NG: CHN-MM-4-3FE 
X-Mod-Name: Mvod-Server/4.3.3 
Accept-Ranges: bytes  
</code></pre>

<p>可见，Nginx终于成功的返回200了。此时，Nginx才真正起到了一个Proxy的功能，隐藏了一个请求原本的多个302链路，只返回客户端一个最终结果。</p>

<h3 id="5-小结">5. 小结</h3>

<p>综上，通过proxy_pass、error_page、proxy_intercept_errors、recursive_error_pages这几个指令的配合使用，可以向客户端隐藏一条请求的跳转细节，直接返回用户一个状态码为200的最终结果。</p>

<p>奇怪的是，在Nginx的官方wiki中并没有recursive_error_pages指令的相关说明。</p>
    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2014/08/24/what-i-talk-about-when-i-talk-about-running.html">读《当我谈跑步时我谈些什么》有感</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2014-08-24" class="post-time">
        2014-08-24
      </time>
      
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <p>从来都不会想到，村上会是一个生活极其规律，几十年如一日坚持跑步训练，长期参与世界各地的马拉松比赛，甚至是铁人三项比赛的人。</p>

<p>在看完这本书并了解到这一点后，我又很难想象这样一个人居然是《挪威的森林》的作者。</p>

<p>其实，村上在书中某一章详细的回忆了当初是如何开始跑步的。他跑步的初衷不能说不简单，就是保持身体健康，以能写出更多更好的小说来：</p>

<blockquote>
<p>打算作为小说家度过今后漫长的人生，就必须找到一个既能维持体力，又可将体重保持得恰到好处的方法。</p>
</blockquote>

<p>是的，这就是他跑步几十年最原始的动力。娓娓道来，平淡如水。</p>

<p>可我读起来，总觉得哪里不对劲。直到我把书都看完了，才想起为什么不对劲来。</p>

<blockquote>
<p>打算作为小说家度过今后漫长的人生，就必须找到一个既能维持体力，又可将体重保持得恰到好处的方法。</p>
</blockquote>

<p>按照这种说法，可以衍生出无数的句子，例如：</p>

<ol>
<li>打算作为程序员度过今后漫长的人生，就必须找到一个既能维持体力，又可将体重保持得恰到好处的方法。<br /></li>
<li>打算作为产品经理度过今后漫长的人生，就必须找到一个既能维持体力，又可将体重保持得恰到好处的方法。<br /></li>
<li>打算作为投行从业者度过今后漫长的人生，就必须找到一个既能维持体力，又可将体重保持得恰到好处的方法。<br /></li>
<li>&hellip;&hellip;<br />
<br /></li>
</ol>

<p>会直接或间接导致使身体健康恶化的职业，如果有个排名，我想怎么也轮不到作家吧。但为什么这样一个似乎不能构成强大动力的理由，为什么能支撑他走这么久，而我们却很难做到呢？</p>

<p>我想，主要是有两点。</p>

<p>第一，他真正了解自己。</p>

<p>那年他三十三岁，在开始跑步时已经知道自己会作为小说家度过今后漫长的人生。而我们很多人，即使到了三十三岁，恐怕也不知道该以哪一种角色度过这一生。确定了这个简单的目标后，保持身体健康，创作出更多更好的作品是很自然的事情。</p>

<p>以前有段时间很喜欢路遥。看了他的《早晨从中午开始》后更是感动流涕，但现在想想，如果能够保持好的健康状态，即使一辈子只写一本书，是否也能让《平凡的世界》更好一些呢？</p>

<p>第二，极端的自律。</p>

<p>书中有一段讲到，在比赛时，太累的时候，一般人都会用类似于快走的节奏来调整自己的步伐。但他却是会站在原地休息，只要是开始，那就一定是跑。他参加比赛，是来跑步的，不是走路的。</p>

<p>看到这里，读者应该都能知道，即使这是一场有着明确规则和标准的比赛，他仍然坚持自己的一套原则。至于慢走调整步伐合不合理，科不科学，他一概不管。</p>

<p>所以，我认为正是这两点，是他几十年坚持跑步的原因。</p>

<p>书的结尾：</p>

<blockquote>
<p>假如有我的墓志铭，而且上面的文字可以自己选择，我愿意它是这么写的：<br />
村上春树<br />
作家（兼跑者）<br />
1949-20xx<br />
他至少是跑到了最后</p>

<p>此时此刻，这，便是我的愿望。</p>
</blockquote>
    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2014/08/19/start-runngin-again.html">重新开始跑步</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2014-08-19" class="post-time">
        2014-08-19
      </time>
      
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <p>大三那年，跑了整整一年步，风雨无阻。五年后，我再度下了这个决心。</p>

<p>巧得很，正当我下完决心后，发现自己手里捧着一本村上春树的《当我谈跑步时我谈些什么》。当然这只是一种主观的说法，到底是在看这本书书的时候下了决心还是在看书之前已经下了决心，我自己也搞不清了。</p>

<p>跑步其实不仅仅是跑步这项运动。跑步意味着生活的一切都开始逐渐规律化，平静化，意味着对自己的掌控。</p>

<p>希望这是一个新的开始。</p>
    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2014/08/14/local-backup-using-git.html">用git做本地备份</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2014-08-14" class="post-time">
        2014-08-14
      </time>
      
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <p>得益于强大的git以及github、bitbucket之类的外围产品，我们可以很方便的将自己本地的文件推到远端，除了可以完成它原本程序员之间协同工作的功能外，还可以单纯的将git作为本地备份工具来使用。</p>

<p>假设A目录是你的工作目录，这里面的文件经常变动，所以你想使用git来管理，但又不想推到远端，只想在本地保存。最简单的做法就是在工作目录下执行git init，git add, git commit等一系列操作。但这里有一个小问题，假如该目录是一个公用目录或其他原因，导致该目录有可能被直接删除掉，这样即使是git也无力回天了。</p>

<p>进一步想一下，这里有两种做法：</p>

<ol>
<li><p>在另外一个目录B下做一个该工作目录的克隆，每次工作目录提交后，在B下面执行git pull来同步。这样比较麻烦的一点是每次都要切换目录pull。</p></li>

<li><p>在另外一个目录下新建一个裸仓库。执行git init &ndash;bare, 然后在A目录下将这个新建的裸仓库添加到上游upstream。这样每次在工作目录A下commit后，再执行一个push就可以了。</p></li>
</ol>

<p>参考：</p>

<ol>
<li><a href="http://treeleafmedia.be/blog/2011/03/creating-a-new-git-repository-on-a-local-file-system/">http://treeleafmedia.be/blog/2011/03/creating-a-new-git-repository-on-a-local-file-system/</a><br /></li>
</ol>
    </div>
    
  </div>
</article>

  
    <article class="post bg-white">
  <header class="post-header">
    <h1 class="post-title">
      
      <a class="post-link" href="/2014/07/30/two-kinds-of-variables-in-ngx-lua.html">ngx.var.arg与ngx.req.get_uri_args的区别</a>
    </h1>
    
    <div class="post-meta">
      <time datetime="2014-07-30" class="post-time">
        2014-07-30
      </time>
      
      
      
      
    </div>
  </header>
  
  <div class="post-content">
    
    <div class="post-summary">
      <p>ngx.var.arg_xx与ngx.req.get_uri_args[&ldquo;xx&rdquo;]两者都是为了获取请求uri中的参数，例如</p>

<pre><code>http://pureage.info?strider=1  
</code></pre>

<p>为了获取输入参数strider，以下两种方法都可以：</p>

<ol>
<li><p>local strider = ngx.var.arg_strider</p></li>

<li><p>local strider = ngx.req.get_uri_args[&ldquo;strider&rdquo;]</p></li>
</ol>

<p>差别在于，当请求uri中有多个同名参数时,ngx.var.arg_xx的做法是取第一个出现的值,ngx.req_get_uri_args[&ldquo;xx&rdquo;]的做法是返回一个table，该table里存放了该参数的所有值，例如,当请求uri为：</p>

<pre><code>http://pureage.info?strider=1&amp;strider=2&amp;strider=3&amp;strider=4  
</code></pre>

<p>时，ngx.var.arg_strider的值为&rdquo;1&rdquo;,而ngx.req.get_uri_args[&ldquo;strider&rdquo;]的值为table [&ldquo;1&rdquo;, &ldquo;2&rdquo;, &ldquo;3&rdquo;, &ldquo;4&rdquo;]。因此，ngx.req.get_uri_args属于ngx.var.arg_的增强。</p>

<p>ngx.var.arg_的实现是直接使用nginx原生的变量支持，nginx相关代码为：</p>

<pre><code>ngx_http_variable_value_t *  
ngx_http_get_variable(ngx_http_request_t *r, ngx_str_t *name, ngx_uint_t key)  
{  
....(略）....  
if (ngx_strncmp(name-&gt;data, &quot;arg_&quot;, 4) == 0) {  
  
        if (ngx_http_variable_argument(r, vv, (uintptr_t) name) == NGX_OK) {  
            return vv;  
        }  
  
        return NULL;  
    }  
  
    vv-&gt;not_found = 1;  
  
    return vv;  
}  
  
static ngx_int_t  
ngx_http_variable_argument(ngx_http_request_t *r, ngx_http_variable_value_t *v,  
    uintptr_t data)  
{  
    ngx_str_t *name = (ngx_str_t *) data;  
  
    u_char *arg;  
    size_t len;  
    ngx_str_t value;  
  
    len = name-&gt;len - (sizeof(&quot;arg_&quot;) - 1);  
    arg = name-&gt;data + sizeof(&quot;arg_&quot;) - 1;  
  
    if (ngx_http_arg(r, arg, len, &amp;value) != NGX_OK) {  
        v-&gt;not_found = 1;  
        return NGX_OK;  
    }  
  
    v-&gt;data = value.data;  
    v-&gt;len = value.len;  
    v-&gt;valid = 1;  
    v-&gt;no_cacheable = 0;  
    v-&gt;not_found = 0;  
  
    return NGX_OK;  
}  
  
ngx_int_t  
ngx_http_arg(ngx_http_request_t *r, u_char *name, size_t len, ngx_str_t *value)  
{  
    u_char *p, *last;  
  
    if (r-&gt;args.len == 0) {  
        return NGX_DECLINED;  
    }  
  
    p = r-&gt;args.data;  
    last = p + r-&gt;args.len;  
  
    for ( /* void */ ; p &lt; last; p++) {  
  
        /* we need '=' after name, so drop one char from last */  
  
        p = ngx_strlcasestrn(p, last - 1, name, len - 1);  
  
        if (p == NULL) {  
            return NGX_DECLINED;  
        }  
  
        if ((p == r-&gt;args.data || *(p - 1) == '&amp;') &amp;&amp; *(p + len) == '=') {  
  
            value-&gt;data = p + len + 1;  
  
            p = ngx_strlchr(p, last, '&amp;');  
  
            if (p == NULL) {  
                p = r-&gt;args.data + r-&gt;args.len;  
            }  
  
            value-&gt;len = p - value-&gt;data;  
  
            return NGX_OK;  
        }  
    }  
  
    return NGX_DECLINED;  
}  
</code></pre>
    </div>
    
  </div>
</article>

  
</section>






  
  
  

  
  

  
  

  
  

  
  

    <nav class="pagination">
      <ul>

      
      
      <li><a href="/">««</a></li>
      

      
      
      <li><a href="/page/14/">«</a></li>
      

      
      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/9/">
              9
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/10/">
              10
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/11/">
              11
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/12/">
              12
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/13/">
              13
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/14/">
              14
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="active">
            <a href="/page/15/">
              15
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/16/">
              16
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/17/">
              17
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/18/">
              18
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/19/">
              19
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/20/">
              20
            </a>
          </li>
        

      

        

        
        

          
          
          

            
              
            

          

        
        

        
        
          <li class="">
            <a href="/page/21/">
              21
            </a>
          </li>
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

        

        
        

          
          
          

            

          

        
        

        
        

      

      
      
      <li><a href="/page/16/">»</a></li>
      

      
      
      <li><a href="/page/37/">»»</a></li>
      

      </ul>
    </nav>
  





        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  


<a href="https://pureage.info/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2011 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        strider
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
