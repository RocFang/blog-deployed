<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Golang中令人不那么愉悦的import - 纯真年代</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Golang中令人不那么愉悦的import" />
<meta property="og:description" content="众所周知，在github上参与开源项目的一般流程如下：


将开源项目fork到自己的名下。
在本地开发环境中clone自己在上一步中fork的项目。
本地完成开发测试和代码提交，再push到自己名下的仓库中。
从自己名下的这个项目中，对原始项目发起一个pull request。
发起的pull request被上游merge后，自己的代码就进入开源项目中了。


虽然具体workflow的细节上可能有些差异，但总体流程大概就是这样。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://pureage.info/post/annoying-golang-import/" />
<meta property="article:published_time" content="2019-03-18T14:49:45&#43;08:00"/>
<meta property="article:modified_time" content="2019-03-18T14:49:45&#43;08:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Golang中令人不那么愉悦的import"/>
<meta name="twitter:description" content="众所周知，在github上参与开源项目的一般流程如下：


将开源项目fork到自己的名下。
在本地开发环境中clone自己在上一步中fork的项目。
本地完成开发测试和代码提交，再push到自己名下的仓库中。
从自己名下的这个项目中，对原始项目发起一个pull request。
发起的pull request被上游merge后，自己的代码就进入开源项目中了。


虽然具体workflow的细节上可能有些差异，但总体流程大概就是这样。"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title">纯真年代</h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">首页</a>
			</li>
			
			<li>
				<a href="/post">归档</a>
			</li>
			
			<li>
				<a href="/about">关于</a>
			</li>
			
			<li>
				<a href="/tags">标签</a>
			</li>
			
			<li>
				<a href="/tools">工具</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Golang中令人不那么愉悦的import</h1>
			<div class="meta">Posted at &mdash; Mar 18, 2019</div>
		</div>

		<div class="markdown">
			<p>众所周知，在github上参与开源项目的一般流程如下：</p>

<ol>
<li>将开源项目fork到自己的名下。</li>
<li>在本地开发环境中clone自己在上一步中fork的项目。</li>
<li>本地完成开发测试和代码提交，再push到自己名下的仓库中。</li>
<li>从自己名下的这个项目中，对原始项目发起一个pull request。</li>
<li>发起的pull request被上游merge后，自己的代码就进入开源项目中了。</li>
</ol>

<p>虽然具体workflow的细节上可能有些差异，但总体流程大概就是这样。</p>

<p>但是在参与Golang的开源项目中，由于gopath的限制，这个流程就会有问题。举个例子，有一个项目为github.com/userA/project，fork之后，有一个新的仓库，路径为github.com/userB/project。而这个project中大概率会有内部package引用，比如在main.go中，import了github.com/userA/project/moduleA，这样在go get自己的仓库时，仍然会引用到原始的仓库路径。将会导致诸如构建失败等一些问题。</p>

<p>为什么基于c/c++的开源项目就没有这个问题呢，因为c/c++的构建更原始更简单。include只有两种形式，要么是在标准路径中或项目子目录中去查找，要么在非标准路径下，但能通过编译器的选项来告诉编译器去哪里找，而代码本身则是非常干净的，不会有硬编码的特定路径在源码里面。而Golang的import，是一个完整的url，这样可以让go get之类的工具自动化的进行一些操作。</p>

<p>上面可以解释Golang项目在引用外部包的时候使用完整url的做法，但是在引用项目内部包时，仍然使用完整url的做法就多少让人觉得有点不能理解。如果import能支持相对路径，就不会有前面提到的问题了。Golang的开发者们当然对这个问题有自己的考虑，参考这个issue：<a href="https://github.com/golang/go/issues/3515">https://github.com/golang/go/issues/3515</a> 。</p>

<p>不能简单的说Golang的这种构建方式不对，因为它的出现必然是有自己的优点和解决了一些问题的，所以从实用的角度出发，我们只能将其称之为“特点”，并去适应它。</p>

<p>解决办法有几个，但都看上去有些丑陋。比如：</p>

<p>在本地开发的时候，使用的路径仍然是原始项目的路径，将自己名下的仓库作为一个remote upstream，push的时候将修改push到自己名下的仓库中，然后再向原始仓库提交pull request。</p>

<p>对于一般的开源项目，这种“临时”的方法就够用了。但在下面的几个场景种，这种方法显然会很令人不适：</p>

<ol>
<li>原始项目已经不维护了，你想自己长期维护一个fork。</li>
<li>原始项目仍然在积极维护，但是你仍然想自己长期维护一个fork。</li>
</ol>

<p>在上述情况下，其实我们是把原始项目和自己的fork当作两个相对独立的项目，我们希望在构建的时候能直接go build就行了，不希望有其他额外的操作。如果有第三个人，他想fork我们这个fork并进行并列开发，按上面的方法将会非常麻烦。</p>

<p>对于这种情况，我选择将项目内所有源码中的import路径，修改为我自己名下的路径。虽然这种做法很丑陋，也是不得已而为之了。</p>
		</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = '';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div><a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


</body>
</html>
